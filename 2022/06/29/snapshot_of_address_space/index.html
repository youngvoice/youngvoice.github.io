<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"youngvoice.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="initial process stack">
<meta property="og:type" content="article">
<meta property="og:title" content="argc, argv, envp, auxiliary vector">
<meta property="og:url" content="https://youngvoice.github.io/2022/06/29/snapshot_of_address_space/index.html">
<meta property="og:site_name" content="I am thinking...">
<meta property="og:description" content="initial process stack">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-06-29T00:00:00.000Z">
<meta property="article:modified_time" content="2023-06-18T07:02:49.358Z">
<meta property="article:author" content="youngvoice">
<meta property="article:tag" content="cs">
<meta property="article:tag" content="knowledge">
<meta property="article:tag" content="process">
<meta property="article:tag" content="csu">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://youngvoice.github.io/2022/06/29/snapshot_of_address_space/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://youngvoice.github.io/2022/06/29/snapshot_of_address_space/","path":"2022/06/29/snapshot_of_address_space/","title":"argc, argv, envp, auxiliary vector"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>argc, argv, envp, auxiliary vector | I am thinking...</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?d0151213913d23785e89cc44331002a7"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">I am thinking...</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">37</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">54</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">41</span></a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#how-to-implement-the-call-to-main-%EF%BC%88focus-on-argc-argv-envp-auxiliary-vector%EF%BC%89"><span class="nav-number">1.</span> <span class="nav-text">how to implement the call to main?（focus on argc, argv, envp, auxiliary vector）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Process-Stack-and-Registers"><span class="nav-number">1.0.0.0.1.</span> <span class="nav-text">Process Stack and Registers</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#what-looks-like-in-initial-process-stack"><span class="nav-number">2.</span> <span class="nav-text">what looks like in initial process stack?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#how-to-combine-many-subroutine-defined-in-x86-assembly-language-into-a-single-program"><span class="nav-number">3.</span> <span class="nav-text">how to combine many subroutine defined in x86 assembly language into a single program?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#how-to-call-a-C-function-through-assembly-language"><span class="nav-number">4.</span> <span class="nav-text">how to call a C function through assembly language?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#how-C-or-C-code-call-assembly-language-subroutines"><span class="nav-number">5.</span> <span class="nav-text">how C or C++ code call assembly language subroutines?</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%8A%8A%E5%A0%86%E6%A0%88%E5%88%86%E9%85%8D%E5%88%B0%E4%BA%86-50%EF%BC%9F%E6%98%AF%E4%B8%8D%E6%98%AF%E5%9B%A0%E4%B8%BA-rsp-%E5%AF%B9%E5%87%86%EF%BC%9F%E8%AF%A5%E5%A0%86%E6%A0%88%E6%98%AF%E6%BB%A1%E5%A0%86%E6%A0%88%E5%90%97%EF%BC%9F%E6%BB%A1%E5%A0%86%E6%A0%88%E9%99%A4%E4%BA%86pop-x2F-push-%E5%86%85%E5%9C%A8%E8%AF%AD%E4%B9%89%E4%B8%8D%E4%B8%80%E6%A0%B7%E4%B9%8B%E5%A4%96%EF%BC%8C%E8%BF%98%E8%83%BD%E6%80%8E%E4%B9%88%E5%88%A4%E6%96%AD%EF%BC%9F"><span class="nav-number">5.0.0.0.1.</span> <span class="nav-text">为什么把堆栈分配到了 50？是不是因为 rsp 对准？该堆栈是满堆栈吗？满堆栈除了pop&#x2F;push 内在语义不一样之外，还能怎么判断？</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%8E%E6%B1%87%E7%BC%96%E7%9A%84-application-%E8%B0%83%E7%94%A8-glibc-%E7%9A%84-printf%EF%BC%9F"><span class="nav-number">6.</span> <span class="nav-text">从汇编的 application 调用 glibc 的 printf？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#how-to-resolve-printf-the-argc-argv-envp-auxiliary-vector-on-initial-process-stack"><span class="nav-number">7.</span> <span class="nav-text">how to resolve (printf) the (argc, argv, envp, auxiliary vector) on initial process stack?</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">youngvoice</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://youngvoice.github.io/2022/06/29/snapshot_of_address_space/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngvoice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I am thinking...">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="argc, argv, envp, auxiliary vector | I am thinking...">
      <meta itemprop="description" content="initial process stack">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          argc, argv, envp, auxiliary vector
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-29 00:00:00" itemprop="dateCreated datePublished" datetime="2022-06-29T00:00:00+00:00">2022-06-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-18 07:02:49" itemprop="dateModified" datetime="2023-06-18T07:02:49+00:00">2023-06-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/" itemprop="url" rel="index"><span itemprop="name">cs</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/knowledge/process/" itemprop="url" rel="index"><span itemprop="name">process</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/knowledge/process/csu/" itemprop="url" rel="index"><span itemprop="name">csu</span></a>
        </span>
    </span>

  
    <span id="/2022/06/29/snapshot_of_address_space/" class="post-meta-item leancloud_visitors" data-flag-title="argc, argv, envp, auxiliary vector" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">initial process stack</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>Operating System Interface<br>Process Initialization</p>
<p>This section describes the machine state that exec(BA_OS) creates for ‘‘infant’’ processes, including argument passing, register usage, stack frame layout, and so on. </p>
<p>Programming language systems use this initial program state to establish a standard environment for their application programs</p>
<h1 id="how-to-implement-the-call-to-main-（focus-on-argc-argv-envp-auxiliary-vector）"><a href="#how-to-implement-the-call-to-main-（focus-on-argc-argv-envp-auxiliary-vector）" class="headerlink" title="how to implement the call to main?（focus on argc, argv, envp, auxiliary vector）"></a>how to implement the call to main?（focus on argc, argv, envp, auxiliary vector）</h1><p>it gives the information necessary to implement the call to main or to the entry point for a program in any other language.</p>
<p>Special Registers<br>several state registers</p>
<h5 id="Process-Stack-and-Registers"><a href="#Process-Stack-and-Registers" class="headerlink" title="Process Stack and Registers"></a>Process Stack and Registers</h5><h1 id="what-looks-like-in-initial-process-stack"><a href="#what-looks-like-in-initial-process-stack" class="headerlink" title="what looks like in initial process stack?"></a>what looks like in initial process stack?</h1><p>Figure 3-31: Initial Process Stack<br>When a process receives control, its stack holds the arguments and environment from exec</p>
<p>Whereas the argument and environment vectors transmit information from one application program to another, the auxiliary vector conveys information from the operating system to the program.</p>
<p>Figure 3-35: Example Process Stack</p>
<h1 id="how-to-combine-many-subroutine-defined-in-x86-assembly-language-into-a-single-program"><a href="#how-to-combine-many-subroutine-defined-in-x86-assembly-language-into-a-single-program" class="headerlink" title="how to combine many subroutine defined in x86 assembly language into a single program?"></a>how to combine many subroutine defined in x86 assembly language into a single program?</h1><p>How are parameters passed to a subroutine?<br>Can subroutines overwrite the values in a register, or does the caller expect the register contents to be preserved?<br>Where should local variables in a subroutine be stored?<br>How should results be returned from functions?</p>
<h1 id="how-to-call-a-C-function-through-assembly-language"><a href="#how-to-call-a-C-function-through-assembly-language" class="headerlink" title="how to call a C function through assembly language?"></a>how to call a C function through assembly language?</h1><h1 id="how-C-or-C-code-call-assembly-language-subroutines"><a href="#how-C-or-C-code-call-assembly-language-subroutines" class="headerlink" title="how C or C++ code call assembly language subroutines?"></a>how C or C++ code call assembly language subroutines?</h1><p>the calling convension is specified in ABI document </p>
<p>two sets of rules:<br>the first set of rules is employed by the caller of the subroutine, and the second set of rules is observed by the writer of the subroutine (the “callee”).</p>
<p>the callee’s rules fall cleanly into two halves that are basically mirror images of one another. The first half of the rules apply to the beginning of the function, and are therefor commonly said to define the prologue to the function. The latter half of the rules apply to the end of the function, and are thus commonly said to define the epilogue of the function.</p>
<p>将如下的 C 语言代码在 X86_64 linux 上编译后进行反汇编</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">callee</span><span class="params">(<span class="type">long</span> arg1, <span class="type">long</span> arg2, <span class="type">long</span> arg3, <span class="type">long</span> arg4, <span class="type">long</span> arg5, <span class="type">long</span> arg6, <span class="type">long</span> arg7, <span class="type">long</span> arg8)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">long</span> ret = <span class="number">0xffffffff</span>;</span><br><span class="line">        ret = arg1 + arg2 + arg3 + arg4 + arg5 + arg6 + arg7 + arg8;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">long</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="type">long</span> arg1 = <span class="number">0xf1</span>, arg2 = <span class="number">0xf2</span>, arg3 = <span class="number">0xf3</span>, arg4 = <span class="number">0xf4</span>, arg5 = <span class="number">0xf5</span>, arg6 = <span class="number">0xf6</span>, arg7 = <span class="number">0xf7</span>, arg8 = <span class="number">0xf8</span>;</span><br><span class="line">        ret = callee(arg1, arg2, arg3, arg4, arg5, arg6, arg7, arg8);</span><br><span class="line">        <span class="keyword">return</span>  ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>objdump 后的反汇编如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">0000000000001191 &lt;main&gt;:</span><br><span class="line">    1191:       f3 0f 1e fa             endbr64</span><br><span class="line">    1195:       55                      push   %rbp</span><br><span class="line">    1196:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    1199:       48 83 ec 50             sub    $0x50,%rsp</span><br><span class="line">    119d:       48 c7 45 b8 00 00 00    movq   $0x0,-0x48(%rbp)</span><br><span class="line">    11a4:       00</span><br><span class="line">    11a5:       48 c7 45 c0 f1 00 00    movq   $0xf1,-0x40(%rbp)</span><br><span class="line">    11ac:       00</span><br><span class="line">    11ad:       48 c7 45 c8 f2 00 00    movq   $0xf2,-0x38(%rbp)</span><br><span class="line">    11b4:       00</span><br><span class="line">    11b5:       48 c7 45 d0 f3 00 00    movq   $0xf3,-0x30(%rbp)</span><br><span class="line">    11bc:       00</span><br><span class="line">    11bd:       48 c7 45 d8 f4 00 00    movq   $0xf4,-0x28(%rbp)</span><br><span class="line">    11c4:       00</span><br><span class="line">    11c5:       48 c7 45 e0 f5 00 00    movq   $0xf5,-0x20(%rbp)</span><br><span class="line">    11cc:       00</span><br><span class="line">    11cd:       48 c7 45 e8 f6 00 00    movq   $0xf6,-0x18(%rbp)</span><br><span class="line">    11d4:       00</span><br><span class="line">    11d5:       48 c7 45 f0 f7 00 00    movq   $0xf7,-0x10(%rbp)</span><br><span class="line">    11dc:       00</span><br><span class="line">    11dd:       48 c7 45 f8 f8 00 00    movq   $0xf8,-0x8(%rbp)</span><br><span class="line">    11e4:       00</span><br><span class="line">    11e5:       4c 8b 45 e8             mov    -0x18(%rbp),%r8</span><br><span class="line">    11e9:       48 8b 7d e0             mov    -0x20(%rbp),%rdi</span><br><span class="line">    11ed:       48 8b 4d d8             mov    -0x28(%rbp),%rcx</span><br><span class="line">    11f1:       48 8b 55 d0             mov    -0x30(%rbp),%rdx</span><br><span class="line">    11f5:       48 8b 75 c8             mov    -0x38(%rbp),%rsi</span><br><span class="line">    11f9:       48 8b 45 c0             mov    -0x40(%rbp),%rax</span><br><span class="line">    11fd:       ff 75 f8                pushq  -0x8(%rbp)</span><br><span class="line">    1200:       ff 75 f0                pushq  -0x10(%rbp)</span><br><span class="line">    1203:       4d 89 c1                mov    %r8,%r9</span><br><span class="line">    1206:       49 89 f8                mov    %rdi,%r8</span><br><span class="line">    1209:       48 89 c7                mov    %rax,%rdi</span><br><span class="line">    120c:       e8 18 ff ff ff          callq  1129 &lt;callee&gt;</span><br><span class="line">    1211:       48 83 c4 10             add    $0x10,%rsp</span><br><span class="line">    1215:       48 89 45 b8             mov    %rax,-0x48(%rbp)</span><br><span class="line">    1219:       48 8b 45 b8             mov    -0x48(%rbp),%rax</span><br><span class="line">    121d:       c9                      leaveq</span><br><span class="line">    121e:       c3                      retq</span><br><span class="line">    121f:       90                      nop</span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>仔细阅读汇编代码可以发现，main 函数在调用callee时，将前面6个参数分别通过 rdi, rsi, rdx, rcx, r8, r9 寄存器进行传递，剩余的两个参数通过堆栈传递，最终在调用callee 时的堆栈分布如下：</p>
<table>
<thead>
<tr>
<th>address offset (rbp)</th>
<th>register &#x2F; variable name</th>
<th>local variable</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>rbp</td>
<td></td>
</tr>
<tr>
<td>-8</td>
<td>arg8</td>
<td>yes</td>
</tr>
<tr>
<td>-10</td>
<td>arg7</td>
<td>yes</td>
</tr>
<tr>
<td>-18</td>
<td>r9&#x2F;arg6</td>
<td>yes</td>
</tr>
<tr>
<td>-20</td>
<td>r8&#x2F;arg5</td>
<td>yes</td>
</tr>
<tr>
<td>-28</td>
<td>rcx&#x2F;arg4</td>
<td>yes</td>
</tr>
<tr>
<td>-30</td>
<td>rdx&#x2F;arg3</td>
<td>yes</td>
</tr>
<tr>
<td>-38</td>
<td>rsi&#x2F;arg2</td>
<td>yes</td>
</tr>
<tr>
<td>-40</td>
<td>rdi&#x2F;arg1</td>
<td>yes</td>
</tr>
<tr>
<td>-48</td>
<td>ret</td>
<td>yes</td>
</tr>
<tr>
<td>-50</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>arg8</td>
<td></td>
</tr>
<tr>
<td></td>
<td>arg7</td>
<td></td>
</tr>
</tbody></table>
<h5 id="为什么把堆栈分配到了-50？是不是因为-rsp-对准？该堆栈是满堆栈吗？满堆栈除了pop-x2F-push-内在语义不一样之外，还能怎么判断？"><a href="#为什么把堆栈分配到了-50？是不是因为-rsp-对准？该堆栈是满堆栈吗？满堆栈除了pop-x2F-push-内在语义不一样之外，还能怎么判断？" class="headerlink" title="为什么把堆栈分配到了 50？是不是因为 rsp 对准？该堆栈是满堆栈吗？满堆栈除了pop&#x2F;push 内在语义不一样之外，还能怎么判断？"></a>为什么把堆栈分配到了 50？是不是因为 rsp 对准？该堆栈是满堆栈吗？满堆栈除了pop&#x2F;push 内在语义不一样之外，还能怎么判断？</h5><p>glibc start code</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//  &quot;./sysdeps/x86_64/start.S&quot;</span><br><span class="line">// Startup code compliant to the ELF x86-64 ABI</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            /* Clear the frame pointer.  The ABI suggests this be done, to mark the outermost frame obviously.  */</span><br><span class="line">                /* Extract the arguments as encoded on the stack and set up</span><br><span class="line">           the arguments for __libc_start_main (int (*main) (int, char **, char **),</span><br><span class="line">                   int argc, char *argv,</span><br><span class="line">                   void (*init) (void), void (*fini) (void),</span><br><span class="line">                   void (*rtld_fini) (void), void *stack_end).</span><br><span class="line">           The arguments are passed via registers and on the stack:</span><br><span class="line">        main:           %rdi</span><br><span class="line">        argc:           %rsi</span><br><span class="line">        argv:           %rdx</span><br><span class="line">        init:           %rcx</span><br><span class="line">        fini:           %r8</span><br><span class="line">        rtld_fini:      %r9</span><br><span class="line">        stack_end:      stack.  */</span><br><span class="line">0000000000401bc0 &lt;_start&gt;:</span><br><span class="line">  401bc0:       f3 0f 1e fa             endbr64</span><br><span class="line">  401bc4:       31 ed                   xor    %ebp,%ebp</span><br><span class="line">  401bc6:       49 89 d1                mov    %rdx,%r9</span><br><span class="line">  401bc9:       5e                      pop    %rsi</span><br><span class="line">  401bca:       48 89 e2                mov    %rsp,%rdx</span><br><span class="line">  401bcd:       48 83 e4 f0             and    $0xfffffffffffffff0,%rsp</span><br><span class="line">  401bd1:       50                      push   %rax</span><br><span class="line">  401bd2:       54                      push   %rsp</span><br><span class="line">  401bd3:       49 c7 c0 80 2d 40 00    mov    $0x402d80,%r8</span><br><span class="line">  401bda:       48 c7 c1 e0 2c 40 00    mov    $0x402ce0,%rcx</span><br><span class="line">  401be1:       48 c7 c7 e5 1c 40 00    mov    $0x401ce5,%rdi</span><br><span class="line">  401be8:       67 e8 92 04 00 00       addr32 callq 402080 &lt;__libc_start_main&gt;</span><br><span class="line">  401bee:       f4                      hlt</span><br><span class="line">  401bef:       90                      nop</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="从汇编的-application-调用-glibc-的-printf？"><a href="#从汇编的-application-调用-glibc-的-printf？" class="headerlink" title="从汇编的 application 调用 glibc 的 printf？"></a>从汇编的 application 调用 glibc 的 printf？</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># &quot;assembly_call_printf.S&quot;</span><br><span class="line">.text</span><br><span class="line">#extern printf</span><br><span class="line">.global printf</span><br><span class="line">.global _start</span><br><span class="line">_start:</span><br><span class="line">    mov $msg, %rdi</span><br><span class="line">    callq printf</span><br><span class="line">    mov $60, %rax</span><br><span class="line">    mov $0, %rdi</span><br><span class="line">    syscall</span><br><span class="line"></span><br><span class="line">msg:</span><br><span class="line">    .ascii &quot;hello\n&quot;</span><br><span class="line">len = . - msg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译方式1</span></span><br><span class="line">as -o assembly_call_printf.o assembly_call_printf.S</span><br><span class="line"><span class="comment"># 编译方式2</span></span><br><span class="line">gcc -c -g  -fno-builtin assembly_call_printf.S</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面的命令链接失败，</span></span><br><span class="line">ld -static assembly_call_printf.o -lc -o assembly_call_printf.elf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面的命令能链接通过，但是无法运行</span></span><br><span class="line">ld  assembly_call_printf.o -lc -o assembly_call_printf.elf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面的链接能通过，运行时segment fault</span></span><br><span class="line"><span class="comment"># segment 发生在 fs 寄存器访问时，如何修正？？？</span></span><br><span class="line">/usr/lib/gcc/x86_64-linux-gnu/9/collect2 -plugin /usr/lib/gcc/x86_64-linux-gnu/9/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/9/lto-wrapper -plugin-opt=-fresolution=/tmp/cckUJeVO.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_eh -plugin-opt=-pass-through=-lc --build-id -m elf_x86_64 --hash-style=gnu --as-needed -static -z relro /usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/9/crtbeginT.o -L/usr/lib/gcc/x86_64-linux-gnu/9 -L/usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/9/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/9/../../.. assembly_call_printf.o --start-group -lgcc -lgcc_eh -lc --end-group /usr/lib/gcc/x86_64-linux-gnu/9/crtend.o /usr/lib/gcc/x86_64-linux-gnu/9/../../../x86_64-linux-gnu/crtn.o</span><br></pre></td></tr></table></figure>

<h1 id="how-to-resolve-printf-the-argc-argv-envp-auxiliary-vector-on-initial-process-stack"><a href="#how-to-resolve-printf-the-argc-argv-envp-auxiliary-vector-on-initial-process-stack" class="headerlink" title="how to resolve (printf) the (argc, argv, envp, auxiliary vector) on initial process stack?"></a>how to resolve (printf) the (argc, argv, envp, auxiliary vector) on initial process stack?</h1><p>Reference<br><a target="_blank" rel="noopener" href="http://www.mindfruit.co.uk/2012/01/initial-stack-reading-process-arguments.html">http://www.mindfruit.co.uk/2012/01/initial-stack-reading-process-arguments.html</a><br><a target="_blank" rel="noopener" href="https://refspecs.linuxbase.org/elf/abi386-4.pdf">https://refspecs.linuxbase.org/elf/abi386-4.pdf</a><br><a target="_blank" rel="noopener" href="https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf">https://refspecs.linuxbase.org/elf/x86_64-abi-0.99.pdf</a><br><a target="_blank" rel="noopener" href="https://aaronbloomfield.github.io/pdr/book/x86-64bit-ccc-chapter.pdf">https://aaronbloomfield.github.io/pdr/book/x86-64bit-ccc-chapter.pdf</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>youngvoice
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://youngvoice.github.io/2022/06/29/snapshot_of_address_space/" title="argc, argv, envp, auxiliary vector">https://youngvoice.github.io/2022/06/29/snapshot_of_address_space/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/cs/" rel="tag"># cs</a>
              <a href="/tags/knowledge/" rel="tag"># knowledge</a>
              <a href="/tags/process/" rel="tag"># process</a>
              <a href="/tags/csu/" rel="tag"># csu</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/06/27/book_versatile_platforms/" rel="prev" title="versatile platform">
                  <i class="fa fa-chevron-left"></i> versatile platform
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/07/03/native_bridge/" rel="next" title="the mechanism of native bridge">
                  the mechanism of native bridge <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2022 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">youngvoice</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"KXmlfX5j58VDYijiWp6nSyxa-gzGzoHsz","app_key":"icP17WRY0W95wXZ7w7X0pDd2","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"youngvoice/comment.youngvoice.github.io","issue_term":"title","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
