<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"youngvoice.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="mit 6.828 lab3">
<meta property="og:type" content="article">
<meta property="og:title" content="6.828 JOS lab3">
<meta property="og:url" content="https://youngvoice.github.io/2022/09/18/6-828-3/index.html">
<meta property="og:site_name" content="I am thinking...">
<meta property="og:description" content="mit 6.828 lab3">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-09-18T00:00:00.000Z">
<meta property="article:modified_time" content="2023-02-04T09:23:00.635Z">
<meta property="article:author" content="youngvoice">
<meta property="article:tag" content="learning">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://youngvoice.github.io/2022/09/18/6-828-3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://youngvoice.github.io/2022/09/18/6-828-3/","path":"2022/09/18/6-828-3/","title":"6.828 JOS lab3"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>6.828 JOS lab3 | I am thinking...</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">I am thinking...</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Part-A-User-Environments-and-Exception-Handling"><span class="nav-number">1.</span> <span class="nav-text">Part A: User Environments and Exception Handling</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E5%B0%86%E4%B8%80%E4%B8%AA%E5%90%AB%E6%9C%89%E7%89%B9%E6%9D%83%E6%8C%87%E4%BB%A4%E7%9A%84%E7%A8%8B%E5%BA%8F%EF%BC%8C%E7%BC%96%E8%AF%91%E6%88%90%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E7%9A%84%E7%A8%8B%E5%BA%8F%EF%BC%8C%E4%BC%9A%E6%8A%A5%E9%94%99%E5%90%97%EF%BC%9F%EF%BC%9F%EF%BC%9F-%E7%BC%96%E8%AF%91%E5%99%A8"><span class="nav-number">2.</span> <span class="nav-text">如果将一个含有特权指令的程序，编译成用户空间的程序，会报错吗？？？(编译器)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E6%88%96%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%BD%BF%E7%94%A8%E7%9A%84%E6%A0%88%EF%BC%88%E5%9C%A8JOS%E4%B8%AD%E6%98%AF%E5%BC%82%E5%B8%B8%E6%A0%88%EF%BC%8C%E5%9C%A8%E7%8E%B0%E5%9C%A8%E7%9A%84linux%E5%86%85%E6%A0%B8%E4%B8%AD%E4%B9%9F%E6%98%AF%E5%BC%82%E5%B8%B8%E6%A0%88%E5%90%97%EF%BC%89%EF%BC%9F%EF%BC%9F%EF%BC%9F"><span class="nav-number">3.</span> <span class="nav-text">系统调用或异常处理使用的栈（在JOS中是异常栈，在现在的linux内核中也是异常栈吗）？？？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9C%A8%E6%9C%89%E4%BA%86-env-%E4%B9%8B%E5%90%8E%EF%BC%8C%E7%B4%A7%E6%8E%A5%E7%9D%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9F%A5%E9%81%93%E7%9A%84%E6%98%AF%E4%B8%BA%E4%BA%86%E8%AE%A9%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E4%B8%8E%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E5%88%87%E6%8D%A2%EF%BC%8C%E5%BC%82%E5%B8%B8%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7%EF%BC%9F"><span class="nav-number">4.</span> <span class="nav-text">在有了 env 之后，紧接着异常处理，可以知道的是为了让用户空间与内核空间切换，异常的重要性？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-the-mean-of-%E2%80%9C-the-envid-t-x3D-x3D-0-is-special-and-stands-for-the-current-environment-%E2%80%9D"><span class="nav-number">5.</span> <span class="nav-text">What is the mean of “ the envid_t &#x3D;&#x3D; 0 is special, and stands for the current environment.”</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-the-difference-between-active-environments-and-running-environments"><span class="nav-number">6.</span> <span class="nav-text">What is the difference between active environments and running environments???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#environment-%E4%B8%8E-%E7%B1%BB%E5%9E%8B%E4%B8%BA-Env-structure-%E7%9A%84-envs-%E6%95%B0%E7%BB%84%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB%EF%BC%9F"><span class="nav-number">7.</span> <span class="nav-text">environment 与 类型为 Env structure 的 envs 数组之间的关系？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Where-the-thread-and-address-space-in-JOS"><span class="nav-number">8.</span> <span class="nav-text">Where the thread and address space in JOS?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-the-status-of-stack-when-env-runs-in-kernel"><span class="nav-number">9.</span> <span class="nav-text">What is the status of stack when env runs in kernel?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-the-relationship-between-the-saved-registers-the-env-tf-field-and-stack-because-we-know-the-stack-is-very-important-for-thread"><span class="nav-number">10.</span> <span class="nav-text">What is the relationship between the saved registers(the env_tf field) and stack? (because we know the stack is very important for thread)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A0%88%E6%98%AF%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%BC%95%E5%85%A5%E7%9A%84%E6%A6%82%E5%BF%B5%EF%BC%9F"><span class="nav-number">11.</span> <span class="nav-text">栈是什么时候引入的概念？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%92%88%E5%AF%B9%E4%B8%A4%E4%B8%AA%E8%BF%9B%E7%A8%8B%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%B8%A4%E4%B8%AA%E6%A0%88-%E8%BF%99%E9%87%8C%E7%9A%84%E6%A0%88%E6%8C%87%E7%9A%84%E6%98%AF%E7%94%A8%E6%88%B7%E6%A0%88%E8%BF%98%E6%98%AF%E5%86%85%E6%A0%B8%E6%A0%88-%EF%BC%9F%EF%BC%9F%EF%BC%9F"><span class="nav-number">12.</span> <span class="nav-text">针对两个进程为什么需要两个栈(这里的栈指的是用户栈还是内核栈)？？？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-1"><span class="nav-number">13.</span> <span class="nav-text">Exercise 1</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-2"><span class="nav-number">14.</span> <span class="nav-text">Exercise 2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#env-init"><span class="nav-number">14.1.</span> <span class="nav-text">env_init</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#env-setup-vm"><span class="nav-number">14.2.</span> <span class="nav-text">env_setup_vm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#region-alloc"><span class="nav-number">14.3.</span> <span class="nav-text">region_alloc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#load-icode"><span class="nav-number">14.4.</span> <span class="nav-text">load_icode</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%8A%E9%9D%A2%E7%9A%84%E6%93%8D%E4%BD%9C%E9%99%A4%E4%BA%86-copy-%EF%BC%8C%E8%BF%98%E8%83%BD%E9%80%9A%E8%BF%87%E6%98%A0%E5%B0%84%E6%9D%A5%E6%93%8D%E4%BD%9C%E5%90%97%EF%BC%9F"><span class="nav-number">15.</span> <span class="nav-text">上面的操作除了 copy ，还能通过映射来操作吗？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#env-create"><span class="nav-number">15.1.</span> <span class="nav-text">env_create</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%BB%A3%E7%A0%81%E5%A5%BD%E5%83%8F%E6%9C%89%E7%82%B9%E9%97%AE%E9%A2%98-e-gt-env-type-ENV-TYPE-USER"><span class="nav-number">16.</span> <span class="nav-text">上面的代码好像有点问题 e-&gt;env_type &#x3D; ENV_TYPE_USER;???</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#env-run"><span class="nav-number">16.1.</span> <span class="nav-text">env_run</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Once-the-processor-gets-into-user-mode-how-the-kernel-to-recover-control-of-the-processor-from-user-mode-code"><span class="nav-number">17.</span> <span class="nav-text">Once the processor gets into user mode, how the kernel to recover control of the processor from user-mode code???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#How-to-ensures-that-the-kernel-can-be-entered-only-under-carefully-controlled-conditions"><span class="nav-number">18.</span> <span class="nav-text">How to ensures that the kernel can be entered only under carefully controlled conditions???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TSS-%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%88%87%E6%8D%A2%E7%9A%84%E6%97%B6%E6%9C%BA%EF%BC%9F%EF%BC%9F%EF%BC%9F"><span class="nav-number">19.</span> <span class="nav-text">TSS 如何切换，以及切换的时机？？？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-types-of-exceptions-and-interrupts-exist"><span class="nav-number">20.</span> <span class="nav-text">What types of exceptions and interrupts exist?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#When-the-user-stack-change-to-kernel-stack-happen"><span class="nav-number">21.</span> <span class="nav-text">When the user stack change to kernel stack happen???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-the-stack-look-like-when-coming-in-from-user-mode-at-the-beginning-of-the-exception-handler"><span class="nav-number">22.</span> <span class="nav-text">What the stack look like when coming in from user mode at the beginning of the exception handler???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-the-stack-look-like-when-the-interrupt-or-exception-occurs-while-the-processor-is-already-in-kernel-mode"><span class="nav-number">23.</span> <span class="nav-text">What the stack look like when the interrupt or exception occurs while the processor is already in kernel mode???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E7%A8%8B%E5%BA%8F%E4%B8%8E%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E7%9A%84%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%9C%9F%E6%AD%A3%E5%B7%AE%E5%88%AB%E5%88%B0%E5%BA%95%E5%9C%A8%E4%BB%80%E4%B9%88%E5%9C%B0%E6%96%B9%EF%BC%9F%EF%BC%9F%EF%BC%9F"><span class="nav-number">24.</span> <span class="nav-text">内核中的程序与用户空间的程序的真正差别到底在什么地方？？？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-the-overall-flow-of-control-in-handling-exception"><span class="nav-number">25.</span> <span class="nav-text">What is the overall flow of control in handling exception?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-4"><span class="nav-number">26.</span> <span class="nav-text">Exercise 4</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#can-trap-ever-return"><span class="nav-number">27.</span> <span class="nav-text">can trap ever return?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Part-B-Page-Faults-Breakpoints-Exceptions-and-System-Calls"><span class="nav-number">28.</span> <span class="nav-text">Part B: Page Faults, Breakpoints Exceptions, and System Calls</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#How-the-CPL-and-DPL-achieve-the-protection-the-same-as-Questions-3"><span class="nav-number">29.</span> <span class="nav-text">How the CPL and DPL achieve the protection?(the same as Questions 3)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-5-6-7"><span class="nav-number">30.</span> <span class="nav-text">Exercise 5\6\7</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#How-to-single-step-one-instruction-at-a-time-%E8%B0%83%E8%AF%95%E5%99%A8%E4%B8%AD%E7%9A%84%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95%E5%8A%9F%E8%83%BD%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F"><span class="nav-number">31.</span> <span class="nav-text">How to single-step one instruction at a time ???(调试器中的断点调试功能是如何实现的？)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#How-the-user-processes-ask-the-kernel-to-do-things-for-them"><span class="nav-number">32.</span> <span class="nav-text">How the user processes ask the kernel to do things for them?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-7"><span class="nav-number">33.</span> <span class="nav-text">Exercise 7</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-the-difference-between-sysenter-x2F-sysexit-instructions-and-int-x2F-iret"><span class="nav-number">34.</span> <span class="nav-text">What is the difference between sysenter&#x2F;sysexit instructions and int&#x2F;iret???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-8"><span class="nav-number">35.</span> <span class="nav-text">Exercise 8</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-the-kernel-does-when-an-instruction-in-user-program-causing-a-fault-traps-into-the-kernel"><span class="nav-number">36.</span> <span class="nav-text">What the kernel does, when an instruction in user program causing a fault, traps into the kernel???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#How-the-automatically-extended-stack-works"><span class="nav-number">37.</span> <span class="nav-text">How the automatically extended stack works???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-problem-of-the-pointer-passed-from-a-user-problem-has"><span class="nav-number">38.</span> <span class="nav-text">What problem of the pointer passed from a user problem has?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-9"><span class="nav-number">39.</span> <span class="nav-text">Exercise 9</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%B9%E5%9C%B0%E5%9D%80%E7%9A%84%E9%9D%9E%E6%B3%95%E8%AE%BF%E9%97%AE%EF%BC%8C%E4%BC%9A%E4%B8%8D%E4%BC%9A%E6%98%AF%E5%9C%A8%E5%86%85%E6%A0%B8%E8%AF%BB%E5%86%99%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E6%8C%87%E9%92%88%E5%BC%95%E8%B5%B7%E7%9A%84%EF%BC%9F%EF%BC%9F%EF%BC%9F"><span class="nav-number">40.</span> <span class="nav-text">对地址的非法访问，会不会是在内核读写用户空间指针引起的？？？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-causes-this-page-fault-Exercise-9"><span class="nav-number">41.</span> <span class="nav-text">What causes this page fault???(Exercise 9)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Summary-above-labs"><span class="nav-number">42.</span> <span class="nav-text">Summary above labs</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">youngvoice</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://youngvoice.github.io/2022/09/18/6-828-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngvoice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I am thinking...">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="6.828 JOS lab3 | I am thinking...">
      <meta itemprop="description" content="mit 6.828 lab3">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          6.828 JOS lab3
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-18 00:00:00" itemprop="dateCreated datePublished" datetime="2022-09-18T00:00:00+00:00">2022-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-02-04 09:23:00" itemprop="dateModified" datetime="2023-02-04T09:23:00+00:00">2023-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/operating-system/" itemprop="url" rel="index"><span itemprop="name">operating system</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/operating-system/JOS-series/" itemprop="url" rel="index"><span itemprop="name">JOS series</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">mit 6.828 lab3</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Part-A-User-Environments-and-Exception-Handling"><a href="#Part-A-User-Environments-and-Exception-Handling" class="headerlink" title="Part A: User Environments and Exception Handling"></a>Part A: User Environments and Exception Handling</h1><h1 id="如果将一个含有特权指令的程序，编译成用户空间的程序，会报错吗？？？-编译器"><a href="#如果将一个含有特权指令的程序，编译成用户空间的程序，会报错吗？？？-编译器" class="headerlink" title="如果将一个含有特权指令的程序，编译成用户空间的程序，会报错吗？？？(编译器)"></a>如果将一个含有特权指令的程序，编译成用户空间的程序，会报错吗？？？(编译器)</h1><h1 id="系统调用或异常处理使用的栈（在JOS中是异常栈，在现在的linux内核中也是异常栈吗）？？？"><a href="#系统调用或异常处理使用的栈（在JOS中是异常栈，在现在的linux内核中也是异常栈吗）？？？" class="headerlink" title="系统调用或异常处理使用的栈（在JOS中是异常栈，在现在的linux内核中也是异常栈吗）？？？"></a>系统调用或异常处理使用的栈（在JOS中是异常栈，在现在的linux内核中也是异常栈吗）？？？</h1><p>这个问题本身有些问题？</p>
<h1 id="在有了-env-之后，紧接着异常处理，可以知道的是为了让用户空间与内核空间切换，异常的重要性？"><a href="#在有了-env-之后，紧接着异常处理，可以知道的是为了让用户空间与内核空间切换，异常的重要性？" class="headerlink" title="在有了 env 之后，紧接着异常处理，可以知道的是为了让用户空间与内核空间切换，异常的重要性？"></a>在有了 env 之后，紧接着异常处理，可以知道的是为了让用户空间与内核空间切换，异常的重要性？</h1><p>(在单片机中中断的作用好像有点不一样，但是将异常和信号结合起来之和与单片机的中断就有点像了)</p>
<h1 id="What-is-the-mean-of-“-the-envid-t-x3D-x3D-0-is-special-and-stands-for-the-current-environment-”"><a href="#What-is-the-mean-of-“-the-envid-t-x3D-x3D-0-is-special-and-stands-for-the-current-environment-”" class="headerlink" title="What is the mean of “ the envid_t &#x3D;&#x3D; 0 is special, and stands for the current environment.”"></a>What is the mean of “ the envid_t &#x3D;&#x3D; 0 is special, and stands for the current environment.”</h1><p>是不是新建 env 的时候起作用？</p>
<h1 id="What-is-the-difference-between-active-environments-and-running-environments"><a href="#What-is-the-difference-between-active-environments-and-running-environments" class="headerlink" title="What is the difference between active environments and running environments???"></a>What is the difference between active environments and running environments???</h1><h1 id="environment-与-类型为-Env-structure-的-envs-数组之间的关系？"><a href="#environment-与-类型为-Env-structure-的-envs-数组之间的关系？" class="headerlink" title="environment 与 类型为 Env structure 的 envs 数组之间的关系？"></a>environment 与 类型为 Env structure 的 envs 数组之间的关系？</h1><p>environment 可以占用同一个 envs 数组的 slot，但是 envid_t 不一样</p>
<p>一个 environment 有一个 page directory</p>
<h1 id="Where-the-thread-and-address-space-in-JOS"><a href="#Where-the-thread-and-address-space-in-JOS" class="headerlink" title="Where the thread and address space in JOS?"></a>Where the thread and address space in JOS?</h1><p>Like a unix process, Jos couples the concepts of “thread” and “address space”. The thread is defined primarily by the saved registers(the env_tf field), and the address space is defined by the page directory and page tables pointed to by env_pgdir.</p>
<p>To run an environment, the kernel must set up the CPU with both the saved registers and the appropriate address space.</p>
<p>In Jos, individual environment do not have their own kernel stacks as process do in xv6. There can be only one JOS environment active in the kernel at a time, so Jos needs only a single kernel stack.</p>
<p>为了运行一个进程，我们需要加载 地址空间 + 运行时（寄存器）(因为公用内核栈，所以进程的栈在用户空间唯一，即恢复了寄存器就可以恢复用户栈)<br>把用户空间状态保存在 Trapframe 的问题（内存地址空间本来是空的，我们通过运行时来让其改变）</p>
<h1 id="What-is-the-status-of-stack-when-env-runs-in-kernel"><a href="#What-is-the-status-of-stack-when-env-runs-in-kernel" class="headerlink" title="What is the status of stack when env runs in kernel?"></a>What is the status of stack when env runs in kernel?</h1><h1 id="What-is-the-relationship-between-the-saved-registers-the-env-tf-field-and-stack-because-we-know-the-stack-is-very-important-for-thread"><a href="#What-is-the-relationship-between-the-saved-registers-the-env-tf-field-and-stack-because-we-know-the-stack-is-very-important-for-thread" class="headerlink" title="What is the relationship between the saved registers(the env_tf field) and stack? (because we know the stack is very important for thread)"></a>What is the relationship between the saved registers(the env_tf field) and stack? (because we know the stack is very important for thread)</h1><h1 id="栈是什么时候引入的概念？"><a href="#栈是什么时候引入的概念？" class="headerlink" title="栈是什么时候引入的概念？"></a>栈是什么时候引入的概念？</h1><h1 id="针对两个进程为什么需要两个栈-这里的栈指的是用户栈还是内核栈-？？？"><a href="#针对两个进程为什么需要两个栈-这里的栈指的是用户栈还是内核栈-？？？" class="headerlink" title="针对两个进程为什么需要两个栈(这里的栈指的是用户栈还是内核栈)？？？"></a>针对两个进程为什么需要两个栈(这里的栈指的是用户栈还是内核栈)？？？</h1><h1 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">mem_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line">        <span class="comment">// Make &#x27;envs&#x27; point to an array of size &#x27;NENV&#x27; of &#x27;struct Env&#x27;.</span></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        envs = (<span class="keyword">struct</span> Env *)boot_alloc(NENV*<span class="keyword">sizeof</span>(<span class="keyword">struct</span> Env));</span><br><span class="line">        <span class="built_in">memset</span>(envs, <span class="number">0</span>, NENV*<span class="keyword">sizeof</span>(<span class="keyword">struct</span> Env));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//////////////////////////////////////////////////////////////////////</span></span><br><span class="line">        <span class="comment">// Map the &#x27;envs&#x27; array read-only by the user at linear address UENVS</span></span><br><span class="line">        <span class="comment">// (ie. perm = PTE_U | PTE_P).</span></span><br><span class="line">        <span class="comment">// Permissions:</span></span><br><span class="line">        <span class="comment">//    - the new image at UENVS  -- kernel R, user R</span></span><br><span class="line">        <span class="comment">//    - envs itself -- kernel RW, user NONE</span></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        boot_map_region(kern_pgdir, UENVS, PTSIZE, PADDR(envs), PTE_U | PTE_P);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h1><h2 id="env-init"><a href="#env-init" class="headerlink" title="env_init"></a>env_init</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Set up envs array</span></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = NENV - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                envs[i].env_id = <span class="number">0</span>;</span><br><span class="line">                envs[i].env_status = ENV_FREE;</span><br><span class="line">                envs[i].env_link = env_free_list;</span><br><span class="line">                env_free_list = &amp;envs[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Per-CPU part of the initialization</span></span><br><span class="line">        env_init_percpu();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="env-setup-vm"><a href="#env-setup-vm" class="headerlink" title="env_setup_vm"></a>env_setup_vm</h2><p>初始化 environment e 的内核虚拟内存地址空间布局，主要是复制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">env_setup_vm</span><span class="params">(<span class="keyword">struct</span> Env *e)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">p</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allocate a page for the page directory</span></span><br><span class="line">        <span class="keyword">if</span> (!(p = page_alloc(ALLOC_ZERO)))</span><br><span class="line">                <span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now, set e-&gt;env_pgdir and initialize the page directory.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Hint:</span></span><br><span class="line">        <span class="comment">//    - The VA space of all envs is identical above UTOP</span></span><br><span class="line">        <span class="comment">//      (except at UVPT, which we&#x27;ve set below).</span></span><br><span class="line">        <span class="comment">//      See inc/memlayout.h for permissions and layout.</span></span><br><span class="line">        <span class="comment">//      Can you use kern_pgdir as a template?  Hint: Yes.</span></span><br><span class="line">        <span class="comment">//      (Make sure you got the permissions right in Lab 2.)</span></span><br><span class="line">        <span class="comment">//    - The initial VA below UTOP is empty.</span></span><br><span class="line">        <span class="comment">//    - You do not need to make any more calls to page_alloc.</span></span><br><span class="line">        <span class="comment">//    - Note: In general, pp_ref is not maintained for</span></span><br><span class="line">        <span class="comment">//      physical pages mapped only above UTOP, but env_pgdir</span></span><br><span class="line">        <span class="comment">//      is an exception -- you need to increment env_pgdir&#x27;s</span></span><br><span class="line">        <span class="comment">//      pp_ref for env_free to work correctly.</span></span><br><span class="line">        <span class="comment">//    - The functions in kern/pmap.h are handy.</span></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        p-&gt;pp_ref += <span class="number">1</span>;</span><br><span class="line">        e-&gt;env_pgdir = page2kva(p);</span><br><span class="line">        <span class="built_in">memcpy</span>(e-&gt;env_pgdir, kern_pgdir, PGSIZE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// UVPT maps the env&#x27;s own page table read-only.</span></span><br><span class="line">        <span class="comment">// Permissions: kernel R, user R</span></span><br><span class="line">        e-&gt;env_pgdir[PDX(UVPT)] = PADDR(e-&gt;env_pgdir) | PTE_P | PTE_U;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="region-alloc"><a href="#region-alloc" class="headerlink" title="region_alloc"></a>region_alloc</h2><p>分配物理内存，然后将其映射到 environment 的虚拟地址空间 va 处</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">region_alloc</span><span class="params">(<span class="keyword">struct</span> Env *e, <span class="type">void</span> *va, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        <span class="comment">// (But only if you need it for load_icode.)</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Hint: It is easier to use region_alloc if the caller can pass</span></span><br><span class="line">        <span class="comment">//   &#x27;va&#x27; and &#x27;len&#x27; values that are not page-aligned.</span></span><br><span class="line">        <span class="comment">//   You should round va down, and round (va + len) up.</span></span><br><span class="line">        <span class="comment">//   (Watch out for corner-cases!)</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">p</span>;</span></span><br><span class="line">        <span class="type">int</span> num_pages = (ROUNDUP((<span class="type">uintptr_t</span>)va+len, PGSIZE) - ROUNDDOWN((<span class="type">uintptr_t</span>)va, PGSIZE)) / PGSIZE;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">uintptr_t</span> i_va = ROUNDDOWN((<span class="type">uintptr_t</span>)va, PGSIZE); i_va &lt; ROUNDUP((<span class="type">uintptr_t</span>)va + len, PGSIZE); i_va += PGSIZE)</span><br><span class="line">        &#123;</span><br><span class="line">                p = page_alloc(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="literal">NULL</span>)</span><br><span class="line">                        panic(<span class="string">&quot;page_alloc fail!&quot;</span>);</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                // first wrong version</span></span><br><span class="line"><span class="comment">                boot_map_region(e-&gt;pgdir, i_va, page2pa(p), PTE_W | PTE_U);</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">if</span> (page_insert(e-&gt;env_pgdir, p, (<span class="type">void</span> *)i_va, PTE_W | PTE_U) &lt; <span class="number">0</span>)</span><br><span class="line">                        panic(<span class="string">&quot;page_inset fail!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="load-icode"><a href="#load-icode" class="headerlink" title="load_icode"></a>load_icode</h2><ol>
<li>加载一个 user ELF binary image 到一个新的 environment 的 user address space 中</li>
<li>设置用户栈</li>
<li>设置 processor flags</li>
</ol>
<p>该函数是在内核启动初始化过程中调用的，也就是初始化了用户空间的第一个程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">load_icode</span><span class="params">(<span class="keyword">struct</span> Env *e, <span class="type">uint8_t</span> *binary)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Hints:</span></span><br><span class="line">        <span class="comment">//  Load each program segment into virtual memory</span></span><br><span class="line">        <span class="comment">//  at the address specified in the ELF segment header.</span></span><br><span class="line">        <span class="comment">//  You should only load segments with ph-&gt;p_type == ELF_PROG_LOAD.</span></span><br><span class="line">        <span class="comment">//  Each segment&#x27;s virtual address can be found in ph-&gt;p_va</span></span><br><span class="line">        <span class="comment">//  and its size in memory can be found in ph-&gt;p_memsz.</span></span><br><span class="line">        <span class="comment">//  The ph-&gt;p_filesz bytes from the ELF binary, starting at</span></span><br><span class="line">        <span class="comment">//  &#x27;binary + ph-&gt;p_offset&#x27;, should be copied to virtual address</span></span><br><span class="line">        <span class="comment">//  ph-&gt;p_va.  Any remaining memory bytes should be cleared to zero.</span></span><br><span class="line">        <span class="comment">//  (The ELF header should have ph-&gt;p_filesz &lt;= ph-&gt;p_memsz.)</span></span><br><span class="line">        <span class="comment">//  Use functions from the previous lab to allocate and map pages.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  All page protection bits should be user read/write for now.</span></span><br><span class="line">        <span class="comment">//  ELF segments are not necessarily page-aligned, but you can</span></span><br><span class="line">        <span class="comment">//  assume for this function that no two segments will touch</span></span><br><span class="line">        <span class="comment">//  the same virtual page.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  You may find a function like region_alloc useful.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  Loading the segments is much simpler if you can move data</span></span><br><span class="line">        <span class="comment">//  directly into the virtual addresses stored in the ELF binary.</span></span><br><span class="line">        <span class="comment">//  So which page directory should be in force during</span></span><br><span class="line">        <span class="comment">//  this function?</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  You must also do something with the program&#x27;s entry point,</span></span><br><span class="line">        <span class="comment">//  to make sure that the environment starts executing there.</span></span><br><span class="line">        <span class="comment">//  What?  (See env_run() and env_pop_tf() below.)</span></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Elf</span> *<span class="title">elfhdr</span> =</span> (<span class="keyword">struct</span> Elf *)binary;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Proghdr</span> *<span class="title">ph</span>, *<span class="title">eph</span>;</span></span><br><span class="line">        ph = (<span class="keyword">struct</span> Proghdr *)((<span class="type">uint8_t</span> *)elfhdr + elfhdr-&gt;e_phoff);</span><br><span class="line">        eph = ph + elfhdr-&gt;e_phnum;</span><br><span class="line"></span><br><span class="line">        lcr3(PADDR(e-&gt;env_pgdir));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (; ph &lt; eph; ph++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ph-&gt;p_type == ELF_PROG_LOAD) &#123;</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        ph-&gt;p_va, ph-&gt;p_va + ph-&gt;p_memsz;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                        ph-&gt;p_filesz;</span></span><br><span class="line"><span class="comment">                        binary + ph-&gt;p_offset ===&gt; ph-&gt;p_va</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                        <span class="comment">//map dest virtual address range</span></span><br><span class="line">                        region_alloc(e, (<span class="type">void</span> *)ph-&gt;p_va, ph-&gt;p_memsz);</span><br><span class="line">                        <span class="comment">//xjk <span class="doctag">NOTE:</span> kernel manipulate the user space</span></span><br><span class="line">                        <span class="built_in">memcpy</span>((<span class="type">void</span> *)ph-&gt;p_va, binary + ph-&gt;p_offset, ph-&gt;p_filesz);</span><br><span class="line">                        <span class="built_in">memset</span>((<span class="type">void</span> *)ph-&gt;p_va + ph-&gt;p_filesz, <span class="number">0</span>, ph-&gt;p_memsz - ph-&gt;p_filesz);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        e-&gt;env_tf.tf_eip = elfhdr-&gt;e_entry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now map one page for the program&#x27;s initial stack</span></span><br><span class="line">        <span class="comment">// at virtual address USTACKTOP - PGSIZE.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        region_alloc(e, (<span class="type">void</span> *)(USTACKTOP - PGSIZE), PGSIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="上面的操作除了-copy-，还能通过映射来操作吗？"><a href="#上面的操作除了-copy-，还能通过映射来操作吗？" class="headerlink" title="上面的操作除了 copy ，还能通过映射来操作吗？"></a>上面的操作除了 copy ，还能通过映射来操作吗？</h1><h2 id="env-create"><a href="#env-create" class="headerlink" title="env_create"></a>env_create</h2><p>env_alloc + load_icode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_create</span><span class="params">(<span class="type">uint8_t</span> *binary, <span class="keyword">enum</span> EnvType type)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        <span class="comment">// xjk what is the binary stand for a filename or ???</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">e</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (env_alloc(&amp;e, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">                panic(<span class="string">&quot;env_alloc error!&quot;</span>);</span><br><span class="line">        load_icode(e, binary);</span><br><span class="line">        e-&gt;env_type = ENV_TYPE_USER;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="上面的代码好像有点问题-e-gt-env-type-ENV-TYPE-USER"><a href="#上面的代码好像有点问题-e-gt-env-type-ENV-TYPE-USER" class="headerlink" title="上面的代码好像有点问题 e-&gt;env_type = ENV_TYPE_USER;???"></a>上面的代码好像有点问题 <code>e-&gt;env_type = ENV_TYPE_USER;</code>???</h1><h2 id="env-run"><a href="#env-run" class="headerlink" title="env_run"></a>env_run</h2><p>从 curenv 的上下文切换到 e 的上下文</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_run</span><span class="params">(<span class="keyword">struct</span> Env *e)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        <span class="keyword">if</span> (curenv != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (curenv-&gt;env_status == ENV_RUNNING)</span><br><span class="line">                        curenv-&gt;env_status = ENV_RUNNABLE;</span><br><span class="line">        &#125;</span><br><span class="line">        curenv = e;</span><br><span class="line">        e-&gt;env_status = ENV_RUNNING;</span><br><span class="line">        e-&gt;env_runs++;</span><br><span class="line">        lcr3(PADDR(e-&gt;env_pgdir));</span><br><span class="line">        env_pop_tf(&amp;(e-&gt;env_tf));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        panic(<span class="string">&quot;env_run not yet implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="Once-the-processor-gets-into-user-mode-how-the-kernel-to-recover-control-of-the-processor-from-user-mode-code"><a href="#Once-the-processor-gets-into-user-mode-how-the-kernel-to-recover-control-of-the-processor-from-user-mode-code" class="headerlink" title="Once the processor gets into user mode, how the kernel to recover control of the processor from user-mode code???"></a>Once the processor gets into user mode, how the kernel to recover control of the processor from user-mode code???</h1><p>X86 interrupt and exception mechanism</p>
<p>In Intel’s terminology, an interrupt is a protected control transfer that is caused by asynchronous event usually external to the processor, such as notification of external device I&#x2F;O activity.</p>
<p>An exception, in contrast, is a protected control transfer caused synchronously by the currently running code, for example due to a divide by zero or an invalid memory access.</p>
<h1 id="How-to-ensures-that-the-kernel-can-be-entered-only-under-carefully-controlled-conditions"><a href="#How-to-ensures-that-the-kernel-can-be-entered-only-under-carefully-controlled-conditions" class="headerlink" title="How to ensures that the kernel can be entered only under carefully controlled conditions???"></a>How to ensures that the kernel can be entered only under carefully controlled conditions???</h1><p>two mechanisms</p>
<ol>
<li>The Interrupt Descriptor Table</li>
</ol>
<p>the cpu uses the interrupt vector as an index into the processor’s interrupt descriptor table. From the appropriate entry in this table the processor loads:<br>EIP: pointing to the kernel code designated to handle that type of exception.<br>CS: the privilege level at which the exception handler is to run.</p>
<ol start="2">
<li>The Task State Segment<br>the save area for the old processor state must in turn be protected from unprivileged user-mode code;<br>TSS &#x3D;&gt; a stack in kernel memory &#x3D;&gt; segment selector and address where this stack lives</li>
</ol>
<p>The processor pushes SS, ESP, EFLAGS, CS, EIP and an optional error code on this new stack. Then it loads the CS and EIP from the interrupt descriptor, and sets the SS and ESP to refer to the new stack.</p>
<p><strong>上面论述是不是有点问题？应该是下面这样：</strong><br>The processor switch to new stack, and then pushes SS, ESP, EFLAGS, CS, EIP and an optional error code on this new stack. Then it loads the CS and EIP from the interrupt descriptor</p>
<p><strong>上面论述是不是都有点问题？</strong><br>更为准确应该说，我们保存 SS ESP 时，保存的是 old SS ESP 的值，所以<br>old SS ESP 应该被保存在一个临时的地方，才能把新栈的 SS ESP 加载进来，来先完成栈的切换。</p>
<h1 id="TSS-如何切换，以及切换的时机？？？"><a href="#TSS-如何切换，以及切换的时机？？？" class="headerlink" title="TSS 如何切换，以及切换的时机？？？"></a>TSS 如何切换，以及切换的时机？？？</h1><p>因为，一旦从用户态切入内核我们先要找到 TSS ，然后才进行 old state 的保存，接着进行栈切换。<br>所以，我们需要考虑一下，TSS 是保存在什么地方，特别是在内核态允许多个进程同时执行时，与每个进程对应的 TSS 该如何设置？？？</p>
<h1 id="What-types-of-exceptions-and-interrupts-exist"><a href="#What-types-of-exceptions-and-interrupts-exist" class="headerlink" title="What types of exceptions and interrupts exist?"></a>What types of exceptions and interrupts exist?</h1><table>
<thead>
<tr>
<th>range</th>
<th>generate</th>
<th>example</th>
</tr>
</thead>
<tbody><tr>
<td>interrupt vectors between 0 and 31</td>
<td>processor can generate internally</td>
<td>a page fault always causes an exception through vector 14</td>
</tr>
<tr>
<td>Interrupt vectors greater than 31</td>
<td>software interrupts(int instruction) or asynchronous hardware interrupts(external devices)</td>
<td>clock interrupt</td>
</tr>
</tbody></table>
<h1 id="When-the-user-stack-change-to-kernel-stack-happen"><a href="#When-the-user-stack-change-to-kernel-stack-happen" class="headerlink" title="When the user stack change to kernel stack happen???"></a>When the user stack change to kernel stack happen???</h1><p>就目前了解到的应该是异常或中断发生时，就会自动切换（那如何找到这个栈的位置呢，再看看新建 env 时，我们是如何设置的？）</p>
<p>因为，在 JOS 中，只能有一个 env 在内核运行，所以 TSS 只有一个，是在 trap_init_percpu() 中进行初始化的，<strong>之后没有发生变化，因为也不需要发生变化</strong></p>
<h1 id="What-the-stack-look-like-when-coming-in-from-user-mode-at-the-beginning-of-the-exception-handler"><a href="#What-the-stack-look-like-when-coming-in-from-user-mode-at-the-beginning-of-the-exception-handler" class="headerlink" title="What the stack look like when coming in from user mode at the beginning of the exception handler???"></a>What the stack look like when coming in from user mode at the beginning of the exception handler???</h1><p>does not containing an error code<br>need draw …….</p>
<p>containing an error code<br>need draw …….</p>
<h1 id="What-the-stack-look-like-when-the-interrupt-or-exception-occurs-while-the-processor-is-already-in-kernel-mode"><a href="#What-the-stack-look-like-when-the-interrupt-or-exception-occurs-while-the-processor-is-already-in-kernel-mode" class="headerlink" title="What the stack look like when the interrupt or exception occurs while the processor is already in kernel mode???"></a>What the stack look like when the interrupt or exception occurs while the processor is already in kernel mode???</h1><p>does not containing an error code<br>need draw …….</p>
<p>containing an error code<br>need draw …….</p>
<h1 id="内核中的程序与用户空间的程序的真正差别到底在什么地方？？？"><a href="#内核中的程序与用户空间的程序的真正差别到底在什么地方？？？" class="headerlink" title="内核中的程序与用户空间的程序的真正差别到底在什么地方？？？"></a>内核中的程序与用户空间的程序的真正差别到底在什么地方？？？</h1><p>特权指令</p>
<h1 id="What-is-the-overall-flow-of-control-in-handling-exception"><a href="#What-is-the-overall-flow-of-control-in-handling-exception" class="headerlink" title="What is the overall flow of control in handling exception?"></a>What is the overall flow of control in handling exception?</h1><h1 id="Exercise-4"><a href="#Exercise-4" class="headerlink" title="Exercise 4"></a>Exercise 4</h1><ol>
<li>for every T_* interrupt vector(inc&#x2F;trap.h) define a trap handler’s entry point(trapentry.S)</li>
<li>initialize the idt to point to each of these entry points defined in trapentry.S</li>
</ol>
<p>add follow code in trapentry.S</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Lab 3: Your code here for generating entry points for the different traps.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">TRAPHANDLER_NOEC(entry_handle_divide, T_DIVIDE)</span></span><br><span class="line"><span class="comment">TRAPHANDLER_NOEC(entry_handle_debug, T_DEBUG)</span></span><br><span class="line"><span class="comment">TRAPHANDLER(entry_handle_pgflt, T_PGFLT)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TRAPHANDLER_NOEC(entry_handle_divide, T_DIVIDE)</span><br><span class="line">TRAPHANDLER_NOEC(entry_handle_debug, T_DEBUG )</span><br><span class="line">TRAPHANDLER_NOEC(entry_handle_nmi, T_NMI   )</span><br><span class="line">TRAPHANDLER_NOEC(entry_handle_brkpt, T_BRKPT )</span><br><span class="line">TRAPHANDLER_NOEC(entry_handle_oflow, T_OFLOW )</span><br><span class="line">TRAPHANDLER_NOEC(entry_handle_bound, T_BOUND )</span><br><span class="line">TRAPHANDLER_NOEC(entry_handle_illop, T_ILLOP )</span><br><span class="line">TRAPHANDLER_NOEC(entry_handle_device, T_DEVICE)</span><br><span class="line">TRAPHANDLER(entry_handle_dblflt, T_DBLFLT)</span><br><span class="line"><span class="comment">//TRAPHANDLEentry_R(handle_copr, #T_COPR)</span></span><br><span class="line">TRAPHANDLER(entry_handle_tss, T_TSS   )</span><br><span class="line">TRAPHANDLER(entry_handle_segnp, T_SEGNP )</span><br><span class="line">TRAPHANDLER(entry_handle_stack, T_STACK )</span><br><span class="line">TRAPHANDLER(entry_handle_gpflt, T_GPFLT )</span><br><span class="line">TRAPHANDLER(entry_handle_pgflt, T_PGFLT )</span><br><span class="line"><span class="comment">//TRAPHANDLEentry_R(handle_res, #T_RES)</span></span><br><span class="line">TRAPHANDLER(entry_handle_fperr, T_FPERR )</span><br><span class="line">TRAPHANDLER(entry_handle_align, T_ALIGN )</span><br><span class="line">TRAPHANDLER(entry_handle_mchk, T_MCHK  )</span><br><span class="line">TRAPHANDLER(entry_handle_simderr, T_SIMDERR)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TRAPHANDLER_NOEC(entry_handle_syscall, T_SYSCALL)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Lab 3: Your code here for _alltraps</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">_alltraps:</span><br><span class="line">        pushl %ds</span><br><span class="line">        pushl %es</span><br><span class="line">        pushal</span><br><span class="line"></span><br><span class="line">        movl $GD_KD, %eax</span><br><span class="line">        movl %eax, %ds</span><br><span class="line">        movl %eax, %es</span><br><span class="line"></span><br><span class="line">        push %esp</span><br><span class="line">        call trap</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">_alltraps:</span></span><br><span class="line"><span class="comment">        pushl tf_trapno</span></span><br><span class="line"><span class="comment">        pushal tf_padding2</span></span><br><span class="line"><span class="comment">        pushal tf_ds</span></span><br><span class="line"><span class="comment">        pushal tf_padding1</span></span><br><span class="line"><span class="comment">        pushal tf_es</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        pushl reg_eax</span></span><br><span class="line"><span class="comment">        pushl reg_ecx</span></span><br><span class="line"><span class="comment">        pushl reg_edx</span></span><br><span class="line"><span class="comment">        pushl reg_ebx</span></span><br><span class="line"><span class="comment">        pushl reg_oesp</span></span><br><span class="line"><span class="comment">        pushl reg_ebp</span></span><br><span class="line"><span class="comment">        pushl reg_esi</span></span><br><span class="line"><span class="comment">        pushl reg_edi</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        GD_KD %ds</span></span><br><span class="line"><span class="comment">        GD_KD %es</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        pushl %esp</span></span><br><span class="line"><span class="comment">        call trap</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>modify trap_init() as follow in trap.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">trap_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">Segdesc</span> <span class="title">gdt</span>[];</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_divide</span> <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_debug</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_nmi</span>    <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_brkpt</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_oflow</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_bound</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_illop</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_device</span> <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_dblflt</span> <span class="params">()</span>;</span><br><span class="line">        <span class="comment">//extern void //gdt[1] handle_copr, ();</span></span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_tss</span>    <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_segnp</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_stack</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_gpflt</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_pgflt</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="comment">//extern void //dt[1] handle_res,   ();</span></span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_fperr</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_align</span>  <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_mchk</span>   <span class="params">()</span>;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_simderr</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">entry_handle_syscall</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//#define SETGATE(gate, istrap, sel, off, dpl)</span></span><br><span class="line">        SETGATE(idt[T_DIVIDE], <span class="number">1</span>, GD_KT, entry_handle_divide, <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_DEBUG ], <span class="number">1</span>, GD_KT, entry_handle_debug,  <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_NMI   ], <span class="number">1</span>, GD_KT, entry_handle_nmi,    <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_BRKPT ], <span class="number">1</span>, GD_KT, entry_handle_brkpt,  <span class="number">3</span>);</span><br><span class="line">        SETGATE(idt[T_OFLOW ], <span class="number">1</span>, GD_KT, entry_handle_oflow,  <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_BOUND ], <span class="number">1</span>, GD_KT, entry_handle_bound,  <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_ILLOP ], <span class="number">1</span>, GD_KT, entry_handle_illop,  <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_DEVICE], <span class="number">1</span>, GD_KT, entry_handle_device, <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_DBLFLT], <span class="number">1</span>, GD_KT, entry_handle_dblflt, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//SETGATE(entry_R(idt[T_COGD_KT, gdt[1], handle_copr, #0);</span></span><br><span class="line">        SETGATE(idt[T_TSS   ], <span class="number">1</span>, GD_KT, entry_handle_tss,    <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_SEGNP ], <span class="number">1</span>, GD_KT, entry_handle_segnp,  <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_STACK ], <span class="number">1</span>, GD_KT, entry_handle_stack,  <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_GPFLT ], <span class="number">1</span>, GD_KT, entry_handle_gpflt,  <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_PGFLT ], <span class="number">1</span>, GD_KT, entry_handle_pgflt,  <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//SETGATE(entry_R(idt[T_REGD_KT gdt[1], handle_res,   #0);</span></span><br><span class="line">        SETGATE(idt[T_FPERR ], <span class="number">1</span>, GD_KT, entry_handle_fperr,  <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_ALIGN ], <span class="number">1</span>, GD_KT, entry_handle_align,  <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_MCHK  ], <span class="number">1</span>, GD_KT, entry_handle_mchk,   <span class="number">0</span>);</span><br><span class="line">        SETGATE(idt[T_SIMDERR], <span class="number">1</span>,GD_KT, entry_handle_simderr, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        SETGATE(idt[T_SYSCALL], <span class="number">1</span>,GD_KT, entry_handle_syscall, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Per-CPU setup</span></span><br><span class="line">        trap_init_percpu();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="can-trap-ever-return"><a href="#can-trap-ever-return" class="headerlink" title="can trap ever return?"></a>can trap ever return?</h1><h1 id="Part-B-Page-Faults-Breakpoints-Exceptions-and-System-Calls"><a href="#Part-B-Page-Faults-Breakpoints-Exceptions-and-System-Calls" class="headerlink" title="Part B: Page Faults, Breakpoints Exceptions, and System Calls"></a>Part B: Page Faults, Breakpoints Exceptions, and System Calls</h1><h1 id="How-the-CPL-and-DPL-achieve-the-protection-the-same-as-Questions-3"><a href="#How-the-CPL-and-DPL-achieve-the-protection-the-same-as-Questions-3" class="headerlink" title="How the CPL and DPL achieve the protection?(the same as Questions 3)"></a>How the CPL and DPL achieve the protection?(the same as Questions 3)</h1><h1 id="Exercise-5-6-7"><a href="#Exercise-5-6-7" class="headerlink" title="Exercise 5\6\7"></a>Exercise 5\6\7</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">trap_dispatch</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Handle processor exceptions.</span></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        <span class="keyword">if</span> (tf-&gt;tf_trapno == T_PGFLT)</span><br><span class="line">        &#123;</span><br><span class="line">                page_fault_handler(tf);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tf-&gt;tf_trapno == T_BRKPT)</span><br><span class="line">        &#123;</span><br><span class="line">                monitor(tf);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tf-&gt;tf_trapno == T_SYSCALL) &#123;</span><br><span class="line">                <span class="comment">// call syscall() with appropriate arg</span></span><br><span class="line">                tf-&gt;tf_regs.reg_eax = syscall(tf-&gt;tf_regs.reg_eax,</span><br><span class="line">                        tf-&gt;tf_regs.reg_edx,</span><br><span class="line">                        tf-&gt;tf_regs.reg_ecx,</span><br><span class="line">                        tf-&gt;tf_regs.reg_ebx,</span><br><span class="line">                        tf-&gt;tf_regs.reg_edi,</span><br><span class="line">                        tf-&gt;tf_regs.reg_esi);</span><br><span class="line">                <span class="comment">//set return value in %eax</span></span><br><span class="line">                <span class="comment">//tf-&gt;tf_regs.reg_eax = ret</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Unexpected trap: The user process or the kernel has a bug.</span></span><br><span class="line">        print_trapframe(tf);</span><br><span class="line">        <span class="keyword">if</span> (tf-&gt;tf_cs == GD_KT)</span><br><span class="line">                panic(<span class="string">&quot;unhandled trap in kernel&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">                env_destroy(curenv);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="How-to-single-step-one-instruction-at-a-time-调试器中的断点调试功能是如何实现的？"><a href="#How-to-single-step-one-instruction-at-a-time-调试器中的断点调试功能是如何实现的？" class="headerlink" title="How to single-step one instruction at a time ???(调试器中的断点调试功能是如何实现的？)"></a>How to single-step one instruction at a time ???(调试器中的断点调试功能是如何实现的？)</h1><h1 id="How-the-user-processes-ask-the-kernel-to-do-things-for-them"><a href="#How-the-user-processes-ask-the-kernel-to-do-things-for-them" class="headerlink" title="How the user processes ask the kernel to do things for them?"></a>How the user processes ask the kernel to do things for them?</h1><p>how the user processes gets the kernel’s attention?(int)<br>how the user processes specifies which call it wants to execute?(int 0x30)</p>
<p>procedure:</p>
<ol>
<li>the processor and the kernel cooperate to save the user process’s state.</li>
<li>the kernel executes appropriate code in order to carry out the system call.</li>
<li>then resumes the user process.</li>
</ol>
<h1 id="Exercise-7"><a href="#Exercise-7" class="headerlink" title="Exercise 7"></a>Exercise 7</h1><ol>
<li>the handler for interrupt vector T_SYSCALL(trapentry.S and trap_init())</li>
<li>trap_dispatch()</li>
</ol>
<p>The above modify is already finished, can look up in exercise 4&#x2F;5&#x2F;6 in this article.</p>
<ol start="3">
<li>function syscall()<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int32_t</span></span><br><span class="line"><span class="title function_">syscall</span><span class="params">(<span class="type">uint32_t</span> syscallno, <span class="type">uint32_t</span> a1, <span class="type">uint32_t</span> a2, <span class="type">uint32_t</span> a3, <span class="type">uint32_t</span> a4, <span class="type">uint32_t</span> a5)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Call the function corresponding to the &#x27;syscallno&#x27; parameter.</span></span><br><span class="line">        <span class="comment">// Return any appropriate return value.</span></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (syscallno &gt;= NSYSCALLS)</span><br><span class="line">                <span class="keyword">return</span> -E_INVAL;</span><br><span class="line">        <span class="comment">//panic(&quot;syscall not implemented&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (syscallno) &#123;</span><br><span class="line">        <span class="keyword">case</span> SYS_cputs:</span><br><span class="line">                sys_cputs((<span class="type">const</span> <span class="type">char</span> *)a1, a2);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SYS_cgetc:</span><br><span class="line">                <span class="keyword">return</span> sys_cgetc();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SYS_getenvid:</span><br><span class="line">                <span class="keyword">return</span> sys_getenvid();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SYS_env_destroy:</span><br><span class="line">                <span class="keyword">return</span> sys_env_destroy(a1);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> -E_INVAL;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="What-is-the-difference-between-sysenter-x2F-sysexit-instructions-and-int-x2F-iret"><a href="#What-is-the-difference-between-sysenter-x2F-sysexit-instructions-and-int-x2F-iret" class="headerlink" title="What is the difference between sysenter&#x2F;sysexit instructions and int&#x2F;iret???"></a>What is the difference between sysenter&#x2F;sysexit instructions and int&#x2F;iret???</h1><p>sysenter&#x2F;sysexit 与 int&#x2F;iret 是两种有区别的机制，这意味着在初始化及运行过程中对系统调用的机制要保证统一性，也就是如果要切换机制的话，需要改动的地方会比较多。</p>
<p>from the below arguments, we can image the whole running image.</p>
<blockquote>
<p>Specifically, you’ll need to enable interrupts when returning to the user process, which sysexit doesn’t do for you.</p>
</blockquote>
<h1 id="Exercise-8"><a href="#Exercise-8" class="headerlink" title="Exercise 8"></a>Exercise 8</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">libmain</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// set thisenv to point at our Env structure in envs[].</span></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        <span class="comment">//thisenv = 0;</span></span><br><span class="line">        <span class="type">envid_t</span> envid;</span><br><span class="line">        envid = sys_getenvid();</span><br><span class="line">        thisenv = &amp;envs[ENVX(envid)];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// save the name of the program so that panic() can use it</span></span><br><span class="line">        <span class="keyword">if</span> (argc &gt; <span class="number">0</span>)</span><br><span class="line">                binaryname = argv[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// call user main routine</span></span><br><span class="line">        umain(argc, argv);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// exit gracefully</span></span><br><span class="line">        <span class="built_in">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="What-the-kernel-does-when-an-instruction-in-user-program-causing-a-fault-traps-into-the-kernel"><a href="#What-the-kernel-does-when-an-instruction-in-user-program-causing-a-fault-traps-into-the-kernel" class="headerlink" title="What the kernel does, when an instruction in user program causing a fault, traps into the kernel???"></a>What the kernel does, when an instruction in user program causing a fault, traps into the kernel???</h1><p>try to fix it</p>
<h1 id="How-the-automatically-extended-stack-works"><a href="#How-the-automatically-extended-stack-works" class="headerlink" title="How the automatically extended stack works???"></a>How the automatically extended stack works???</h1><h1 id="What-problem-of-the-pointer-passed-from-a-user-problem-has"><a href="#What-problem-of-the-pointer-passed-from-a-user-problem-has" class="headerlink" title="What problem of the pointer passed from a user problem has?"></a>What problem of the pointer passed from a user problem has?</h1><ol>
<li>有没有权限</li>
<li>有效无效</li>
</ol>
<h1 id="Exercise-9"><a href="#Exercise-9" class="headerlink" title="Exercise 9"></a>Exercise 9</h1><h1 id="对地址的非法访问，会不会是在内核读写用户空间指针引起的？？？"><a href="#对地址的非法访问，会不会是在内核读写用户空间指针引起的？？？" class="headerlink" title="对地址的非法访问，会不会是在内核读写用户空间指针引起的？？？"></a>对地址的非法访问，会不会是在内核读写用户空间指针引起的？？？</h1><p>按目前的状态看应该不会发生，因为在内核态访问用户空间地址之前会先进行地址检查，因此，剩下可以引起异常的情况就分成了下面两种：</p>
<ol>
<li>在用户态访问非法地址引起异常</li>
<li>在内核态访问非法地址引起异常</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_fault_handler</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">uint32_t</span> fault_va;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read processor&#x27;s CR2 register to find the faulting address</span></span><br><span class="line">        fault_va = rcr2();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle kernel-mode page faults.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        <span class="keyword">if</span> (tf-&gt;tf_cs &amp; <span class="number">0x3</span>) &#123;</span><br><span class="line">                <span class="comment">// We&#x27;ve already handled kernel-mode exceptions, so if we get here,</span></span><br><span class="line">                <span class="comment">// the page fault happened in user mode.</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Destroy the environment that caused the fault.</span></span><br><span class="line">                cprintf(<span class="string">&quot;[%08x] user fault va %08x ip %08x\n&quot;</span>,</span><br><span class="line">                        curenv-&gt;env_id, fault_va, tf-&gt;tf_eip);</span><br><span class="line">                print_trapframe(tf);</span><br><span class="line">                env_destroy(curenv);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                panic(<span class="string">&quot;page_fault_handler\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">user_mem_check</span><span class="params">(<span class="keyword">struct</span> Env *env, <span class="type">const</span> <span class="type">void</span> *va, <span class="type">size_t</span> len, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        <span class="type">uintptr_t</span> va_start = ROUNDDOWN((<span class="type">uintptr_t</span>)va, PGSIZE);</span><br><span class="line">        <span class="type">uintptr_t</span> va_end = ROUNDUP((<span class="type">uintptr_t</span>)(va + len), PGSIZE);</span><br><span class="line">        <span class="type">uintptr_t</span> va_cur = <span class="number">0</span>;</span><br><span class="line">        <span class="type">size_t</span> num_pages = (va_end - va_start) / PGSIZE;</span><br><span class="line">        <span class="type">size_t</span> i_num_pages = num_pages;</span><br><span class="line">        <span class="type">pte_t</span> *table_entry = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">for</span> (va_cur = va_start, i_num_pages = <span class="number">0</span>; i_num_pages &lt; num_pages; i_num_pages++, va_cur += PGSIZE) &#123;</span><br><span class="line">        <span class="comment">//for (va_cur = va_start ; va_cur &lt; va_end; va_cur += PGSIZE) &#123;</span></span><br><span class="line">                <span class="comment">//find the table entry;</span></span><br><span class="line">                table_entry = <span class="literal">NULL</span>;</span><br><span class="line">                table_entry = pgdir_walk(env-&gt;env_pgdir, (<span class="type">void</span> *)va_cur, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (table_entry == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (i_num_pages == <span class="number">0</span>)</span><br><span class="line">                                user_mem_check_addr = (<span class="type">uintptr_t</span>)va;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (i_num_pages == num_pages)</span><br><span class="line">                                user_mem_check_addr = (<span class="type">uintptr_t</span>)va + len;</span><br><span class="line">                        <span class="keyword">else</span>;</span><br><span class="line">                        <span class="keyword">return</span> -E_FAULT;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//read the permition;</span></span><br><span class="line">                <span class="comment">//compare the permition;</span></span><br><span class="line">                <span class="keyword">if</span> ((PGOFF(*table_entry) &amp; perm)  &amp;&amp; (PGOFF(*table_entry) &amp; PTE_P))</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (i_num_pages == <span class="number">0</span>)</span><br><span class="line">                                user_mem_check_addr = (<span class="type">uintptr_t</span>)va;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span> (i_num_pages == num_pages)</span><br><span class="line">                                user_mem_check_addr = (<span class="type">uintptr_t</span>)va + len;</span><br><span class="line">                        <span class="keyword">else</span>;</span><br><span class="line">                        <span class="keyword">return</span> -E_FAULT;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">sys_cputs</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Check that the user has permission to read memory [s, s+len).</span></span><br><span class="line">        <span class="comment">// Destroy the environment if not.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">        user_mem_assert(curenv, s, len, PTE_U);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Print the string supplied by the user.</span></span><br><span class="line">        cprintf(<span class="string">&quot;%.*s&quot;</span>, len, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">debuginfo_eip</span><span class="params">(<span class="type">uintptr_t</span> addr, <span class="keyword">struct</span> Eipdebuginfo *info)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">Stab</span> *<span class="title">stabs</span>, *<span class="title">stab_end</span>;</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *stabstr, *stabstr_end;</span><br><span class="line">        <span class="type">int</span> lfile, rfile, lfun, rfun, lline, rline;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize *info</span></span><br><span class="line">        info-&gt;eip_file = <span class="string">&quot;&lt;unknown&gt;&quot;</span>;</span><br><span class="line">        info-&gt;eip_line = <span class="number">0</span>;</span><br><span class="line">        info-&gt;eip_fn_name = <span class="string">&quot;&lt;unknown&gt;&quot;</span>;</span><br><span class="line">        info-&gt;eip_fn_namelen = <span class="number">9</span>;</span><br><span class="line">        info-&gt;eip_fn_addr = addr;</span><br><span class="line">        info-&gt;eip_fn_narg = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find the relevant set of stabs</span></span><br><span class="line">        <span class="keyword">if</span> (addr &gt;= ULIM) &#123;</span><br><span class="line">                stabs = __STAB_BEGIN__;</span><br><span class="line">                stab_end = __STAB_END__;</span><br><span class="line">                stabstr = __STABSTR_BEGIN__;</span><br><span class="line">                stabstr_end = __STABSTR_END__;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// The user-application linker script, user/user.ld,</span></span><br><span class="line">                <span class="comment">// puts information about the application&#x27;s stabs (equivalent</span></span><br><span class="line">                <span class="comment">// to __STAB_BEGIN__, __STAB_END__, __STABSTR_BEGIN__, and</span></span><br><span class="line">                <span class="comment">// __STABSTR_END__) in a structure located at virtual address</span></span><br><span class="line">                <span class="comment">// USTABDATA.</span></span><br><span class="line">                <span class="type">const</span> <span class="keyword">struct</span> UserStabData *usd = (<span class="type">const</span> <span class="keyword">struct</span> UserStabData *) USTABDATA;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Make sure this memory is valid.</span></span><br><span class="line">                <span class="comment">// Return -1 if it is not.  Hint: Call user_mem_check.</span></span><br><span class="line">                <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">                <span class="keyword">if</span> (user_mem_check(curenv, usd, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> UserStabData), PTE_U) != <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">                stabs = usd-&gt;stabs;</span><br><span class="line">                stab_end = usd-&gt;stab_end;</span><br><span class="line">                stabstr = usd-&gt;stabstr;</span><br><span class="line">                stabstr_end = usd-&gt;stabstr_end;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Make sure the STABS and string table memory is valid.</span></span><br><span class="line">                <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">                <span class="keyword">if</span> ((user_mem_check(curenv, stabs, __STAB_END__ - __STAB_BEGIN__, PTE_U) != <span class="number">0</span>) || (user_mem_check(curenv, stabstr, __STABSTR_END__ - __STABSTR_BEGIN__, PTE_U) != <span class="number">0</span>))</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// String table validity checks</span></span><br><span class="line">        <span class="keyword">if</span> (stabstr_end &lt;= stabstr || stabstr_end[<span class="number">-1</span>] != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now we find the right stabs that define the function containing</span></span><br><span class="line">        <span class="comment">// &#x27;eip&#x27;.  First, we find the basic source file containing &#x27;eip&#x27;.</span></span><br><span class="line">        <span class="comment">// Then, we look in that source file for the function.  Then we look</span></span><br><span class="line">        <span class="comment">// for the line number.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Search the entire set of stabs for the source file (type N_SO).</span></span><br><span class="line">        lfile = <span class="number">0</span>;</span><br><span class="line">        rfile = (stab_end - stabs) - <span class="number">1</span>;</span><br><span class="line">        stab_binsearch(stabs, &amp;lfile, &amp;rfile, N_SO, addr);</span><br><span class="line">        <span class="keyword">if</span> (lfile == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Search within that file&#x27;s stabs for the function definition</span></span><br><span class="line">        <span class="comment">// (N_FUN).</span></span><br><span class="line">        lfun = lfile;</span><br><span class="line">        rfun = rfile;</span><br><span class="line">        stab_binsearch(stabs, &amp;lfun, &amp;rfun, N_FUN, addr);</span><br><span class="line">        <span class="keyword">if</span> (lfun &lt;= rfun) &#123;</span><br><span class="line">                <span class="comment">// stabs[lfun] points to the function name</span></span><br><span class="line">                <span class="comment">// in the string table, but check bounds just in case.</span></span><br><span class="line">                <span class="keyword">if</span> (stabs[lfun].n_strx &lt; stabstr_end - stabstr)</span><br><span class="line">                        info-&gt;eip_fn_name = stabstr + stabs[lfun].n_strx;</span><br><span class="line">                info-&gt;eip_fn_addr = stabs[lfun].n_value;</span><br><span class="line">                addr -= info-&gt;eip_fn_addr;</span><br><span class="line">                <span class="comment">// Search within the function definition for the line number.</span></span><br><span class="line">                lline = lfun;</span><br><span class="line">                rline = rfun;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Couldn&#x27;t find function stab!  Maybe we&#x27;re in an assembly</span></span><br><span class="line">                <span class="comment">// file.  Search the whole file for the line number.</span></span><br><span class="line">                info-&gt;eip_fn_addr = addr;</span><br><span class="line">                lline = lfile;</span><br><span class="line">                rline = rfile;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Ignore stuff after the colon.</span></span><br><span class="line">        info-&gt;eip_fn_namelen = strfind(info-&gt;eip_fn_name, <span class="string">&#x27;:&#x27;</span>) - info-&gt;eip_fn_name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Search within [lline, rline] for the line number stab.</span></span><br><span class="line">        <span class="comment">// If found, set info-&gt;eip_line to the right line number.</span></span><br><span class="line">        <span class="comment">// If not found, return -1.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Hint:</span></span><br><span class="line">        <span class="comment">//      There&#x27;s a particular stabs type used for line numbers.</span></span><br><span class="line">        <span class="comment">//      Look at the STABS documentation and &lt;inc/stab.h&gt; to find</span></span><br><span class="line">        <span class="comment">//      which one.</span></span><br><span class="line">        <span class="comment">// Your code here.</span></span><br><span class="line">        stab_binsearch(stabs, &amp;lline, &amp;rline, N_SLINE, addr);</span><br><span class="line">        <span class="keyword">if</span> (lline &lt;= rline) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (stabs[lline].n_strx &lt; stabstr_end - stabstr)</span><br><span class="line">                        info-&gt;eip_line = stabs[lline].n_value;</span><br><span class="line">                        <span class="comment">//info-&gt;eip_line = stabs[lline].n_desc;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Search backwards from the line number for the relevant filename</span></span><br><span class="line">        <span class="comment">// stab.</span></span><br><span class="line">        <span class="comment">// We can&#x27;t just use the &quot;lfile&quot; stab because inlined functions</span></span><br><span class="line">        <span class="comment">// can interpolate code from a different file!</span></span><br><span class="line">        <span class="comment">// Such included source files use the N_SOL stab type.</span></span><br><span class="line">        <span class="keyword">while</span> (lline &gt;= lfile</span><br><span class="line">               &amp;&amp; stabs[lline].n_type != N_SOL</span><br><span class="line">               &amp;&amp; (stabs[lline].n_type != N_SO || !stabs[lline].n_value))</span><br><span class="line">                lline--;</span><br><span class="line">        <span class="keyword">if</span> (lline &gt;= lfile &amp;&amp; stabs[lline].n_strx &lt; stabstr_end - stabstr)</span><br><span class="line">                info-&gt;eip_file = stabstr + stabs[lline].n_strx;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set eip_fn_narg to the number of arguments taken by the function,</span></span><br><span class="line">        <span class="comment">// or 0 if there was no containing function.</span></span><br><span class="line">        <span class="keyword">if</span> (lfun &lt; rfun)</span><br><span class="line">                <span class="keyword">for</span> (lline = lfun + <span class="number">1</span>;</span><br><span class="line">                     lline &lt; rfun &amp;&amp; stabs[lline].n_type == N_PSYM;</span><br><span class="line">                     lline++)</span><br><span class="line">                        info-&gt;eip_fn_narg++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h1 id="What-causes-this-page-fault-Exercise-9"><a href="#What-causes-this-page-fault-Exercise-9" class="headerlink" title="What causes this page fault???(Exercise 9)"></a>What causes this page fault???(Exercise 9)</h1><h1 id="Summary-above-labs"><a href="#Summary-above-labs" class="headerlink" title="Summary above labs"></a>Summary above labs</h1><p>env<br>trap<br>mem(phy mem, mem mapping)</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>youngvoice
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://youngvoice.github.io/2022/09/18/6-828-3/" title="6.828 JOS lab3">https://youngvoice.github.io/2022/09/18/6-828-3/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/learning/" rel="tag"># learning</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/09/11/daily/" rel="prev" title="daily">
                  <i class="fa fa-chevron-left"></i> daily
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/09/19/daily/" rel="next" title="由 tty 终端引发的思考？">
                  由 tty 终端引发的思考？ <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2022 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">youngvoice</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
