<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"youngvoice.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="mit 6.828 lab4">
<meta property="og:type" content="article">
<meta property="og:title" content="6.828 JOS lab4">
<meta property="og:url" content="https://youngvoice.github.io/2022/10/09/6-828-4/index.html">
<meta property="og:site_name" content="I am thinking...">
<meta property="og:description" content="mit 6.828 lab4">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-10-09T00:00:00.000Z">
<meta property="article:modified_time" content="2023-02-04T13:46:34.873Z">
<meta property="article:author" content="youngvoice">
<meta property="article:tag" content="cs">
<meta property="article:tag" content="knowledge">
<meta property="article:tag" content="operating system">
<meta property="article:tag" content="JOS">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://youngvoice.github.io/2022/10/09/6-828-4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://youngvoice.github.io/2022/10/09/6-828-4/","path":"2022/10/09/6-828-4/","title":"6.828 JOS lab4"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>6.828 JOS lab4 | I am thinking...</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">I am thinking...</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">25</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">31</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">27</span></a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#What-preemptive-mean-in-this-place"><span class="nav-number">1.</span> <span class="nav-text">What preemptive mean in this place?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-the-state-of-env"><span class="nav-number">2.</span> <span class="nav-text">What is the state of env?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-scheduling"><span class="nav-number">3.</span> <span class="nav-text">What is scheduling?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-the-boot-sequence-of-BSP-bootstrap-processor-and-APs-application-processors"><span class="nav-number">4.</span> <span class="nav-text">What is the boot sequence of BSP(bootstrap processor) and APs(application processors)?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-1"><span class="nav-number">5.</span> <span class="nav-text">Exercise 1</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#bsp-like-cpu-and-ap-like-device"><span class="nav-number">6.</span> <span class="nav-text">bsp like cpu, and ap like device</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-2"><span class="nav-number">7.</span> <span class="nav-text">Exercise 2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Question"><span class="nav-number">8.</span> <span class="nav-text">Question</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-the-gdt-layout"><span class="nav-number">9.</span> <span class="nav-text">What is the gdt layout?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-per-CPU-state"><span class="nav-number">10.</span> <span class="nav-text">What is  per-CPU state?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-3"><span class="nav-number">11.</span> <span class="nav-text">Exercise 3</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BSP-%E9%83%BD%E5%81%9A%E4%BA%86%E5%93%AA%E4%BA%9B%E5%B7%A5%E4%BD%9C%EF%BC%9F"><span class="nav-number">12.</span> <span class="nav-text">BSP 都做了哪些工作？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AP-%E5%9C%A8%E5%90%AF%E5%8A%A8%E9%98%B6%E6%AE%B5%E9%9C%80%E8%A6%81%E5%AE%8C%E6%88%90%E5%93%AA%E4%BA%9B%E5%B7%A5%E4%BD%9C%EF%BC%9F%EF%BC%88%E5%93%AA%E4%BA%9B%E5%88%9D%E5%A7%8B%E5%8C%96%E6%98%AF%E6%AF%8F%E4%B8%AA-cpu-%E9%83%BD%E5%90%84%E8%87%AA%E5%8D%95%E7%8B%AC%E8%BF%90%E8%A1%8C%E4%B8%80%E6%AC%A1%E7%9A%84%EF%BC%9F%EF%BC%89"><span class="nav-number">13.</span> <span class="nav-text">AP 在启动阶段需要完成哪些工作？（哪些初始化是每个 cpu 都各自单独运行一次的？）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-4"><span class="nav-number">14.</span> <span class="nav-text">Exercise 4</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-5"><span class="nav-number">15.</span> <span class="nav-text">Exercise 5</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Question-2"><span class="nav-number">16.</span> <span class="nav-text">Question 2</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-6"><span class="nav-number">17.</span> <span class="nav-text">Exercise 6</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Question-3"><span class="nav-number">18.</span> <span class="nav-text">Question 3</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Question-4"><span class="nav-number">19.</span> <span class="nav-text">Question 4</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-we-need-to-do-for-new-env"><span class="nav-number">20.</span> <span class="nav-text">What we need to do for new env???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%E7%8A%B6%E6%80%81%E4%B9%8B%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-number">21.</span> <span class="nav-text">用户空间状态之寄存器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-7"><span class="nav-number">22.</span> <span class="nav-text">Exercise 7</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#How-the-env-exit"><span class="nav-number">23.</span> <span class="nav-text">How the env exit ???</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#What-is-demand-paged"><span class="nav-number">24.</span> <span class="nav-text">What is demand-paged??</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-8"><span class="nav-number">25.</span> <span class="nav-text">Exercise 8</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-9"><span class="nav-number">26.</span> <span class="nav-text">Exercise 9</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-10"><span class="nav-number">27.</span> <span class="nav-text">Exercise 10</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-11"><span class="nav-number">28.</span> <span class="nav-text">Exercise 11</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NOTE"><span class="nav-number">29.</span> <span class="nav-text">NOTE</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%91%E7%94%9F%E9%A1%B5%E5%BC%82%E5%B8%B8%E6%97%B6%EF%BC%8C%E4%BF%9D%E5%AD%98%E7%9A%84-eip-%E6%98%AF%E5%BD%93%E5%89%8D%E6%AD%A3%E5%9C%A8%E6%89%A7%E8%A1%8C%E7%9A%84%EF%BC%8C%E8%BF%98%E6%98%AF%E5%B0%86%E8%A6%81%E6%89%A7%E8%A1%8C%E7%9A%84%E4%B8%8B%E4%B8%80%E6%9D%A1%E6%8C%87%E4%BB%A4%EF%BC%9F%EF%BC%9F%EF%BC%9F"><span class="nav-number">30.</span> <span class="nav-text">发生页异常时，保存的 eip 是当前正在执行的，还是将要执行的下一条指令？？？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Exercise-12"><span class="nav-number">31.</span> <span class="nav-text">Exercise 12</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9C%A8-JOS-%E4%B8%AD%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%9C%89%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E5%90%97%EF%BC%9F"><span class="nav-number">32.</span> <span class="nav-text">在 JOS 中，虚拟地址空间有管理模块吗？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AE%B5%E9%80%89%E6%8B%A9%E7%AC%A6"><span class="nav-number">33.</span> <span class="nav-text">段选择符?</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">youngvoice</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://youngvoice.github.io/2022/10/09/6-828-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngvoice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I am thinking...">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="6.828 JOS lab4 | I am thinking...">
      <meta itemprop="description" content="mit 6.828 lab4">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          6.828 JOS lab4
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-09 00:00:00" itemprop="dateCreated datePublished" datetime="2022-10-09T00:00:00+00:00">2022-10-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-02-04 13:46:34" itemprop="dateModified" datetime="2023-02-04T13:46:34+00:00">2023-02-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/" itemprop="url" rel="index"><span itemprop="name">cs</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/knowledge/" itemprop="url" rel="index"><span itemprop="name">knowledge</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/knowledge/operating-system/" itemprop="url" rel="index"><span itemprop="name">operating system</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/knowledge/operating-system/JOS/" itemprop="url" rel="index"><span itemprop="name">JOS</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">mit 6.828 lab4</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="What-preemptive-mean-in-this-place"><a href="#What-preemptive-mean-in-this-place" class="headerlink" title="What preemptive mean in this place?"></a>What preemptive mean in this place?</h1><p>此处的抢占是指用户空间，还是内核空间</p>
<p>从抢占的含义来说，是指一个 env 在不由自己控制的情况下被切换出去了</p>
<p>对应到上面，那就是，一个在用户空间运行的 env 被切换出去，或者是在内核空间运行的 env 被切换出去</p>
<p>抢占往往跟 clock interrupt 有关系</p>
<p>在实现抢占之前，可以先实现非抢占的模式</p>
<h1 id="What-is-the-state-of-env"><a href="#What-is-the-state-of-env" class="headerlink" title="What is the state of env?"></a>What is the state of env?</h1><p>因为在这里实现的抢占式多任务是在多个同时处于 active state 的 <strong>user-mode</strong> env 之间实现的</p>
<h1 id="What-is-scheduling"><a href="#What-is-scheduling" class="headerlink" title="What is scheduling?"></a>What is scheduling?</h1><p>选择某一个 env 到某个 cpu 上运行</p>
<h1 id="What-is-the-boot-sequence-of-BSP-bootstrap-processor-and-APs-application-processors"><a href="#What-is-the-boot-sequence-of-BSP-bootstrap-processor-and-APs-application-processors" class="headerlink" title="What is the boot sequence of BSP(bootstrap processor) and APs(application processors)?"></a>What is the boot sequence of BSP(bootstrap processor) and APs(application processors)?</h1><p>BSP is responsible for initializing the system and for booting the operating system; the APs are activated by the BSP only after the operating system is up and running.</p>
<h1 id="Exercise-1"><a href="#Exercise-1" class="headerlink" title="Exercise 1"></a>Exercise 1</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line"><span class="title function_">mmio_map_region</span><span class="params">(<span class="type">physaddr_t</span> pa, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Where to start the next region.  Initially, this is the</span></span><br><span class="line">        <span class="comment">// beginning of the MMIO region.  Because this is static, its</span></span><br><span class="line">        <span class="comment">// value will be preserved between calls to mmio_map_region</span></span><br><span class="line">        <span class="comment">// (just like nextfree in boot_alloc).</span></span><br><span class="line">        <span class="type">static</span> <span class="type">uintptr_t</span> base = MMIOBASE;</span><br><span class="line"></span><br><span class="line">        <span class="type">uintptr_t</span> va = base;</span><br><span class="line">        <span class="comment">// Reserve size bytes of virtual memory starting at base and</span></span><br><span class="line">        <span class="comment">// map physical pages [pa,pa+size) to virtual addresses</span></span><br><span class="line">        <span class="comment">// [base,base+size).  Since this is device memory and not</span></span><br><span class="line">        <span class="comment">// regular DRAM, you&#x27;ll have to tell the CPU that it isn&#x27;t</span></span><br><span class="line">        <span class="comment">// safe to cache access to this memory.  Luckily, the page</span></span><br><span class="line">        <span class="comment">// tables provide bits for this purpose; simply create the</span></span><br><span class="line">        <span class="comment">// mapping with PTE_PCD|PTE_PWT (cache-disable and</span></span><br><span class="line">        <span class="comment">// write-through) in addition to PTE_W.  (If you&#x27;re interested</span></span><br><span class="line">        <span class="comment">// in more details on this, see section 10.5 of IA32 volume</span></span><br><span class="line">        <span class="comment">// 3A.)</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Be sure to round size up to a multiple of PGSIZE and to</span></span><br><span class="line">        <span class="comment">// handle if this reservation would overflow MMIOLIM (it&#x27;s</span></span><br><span class="line">        <span class="comment">// okay to simply panic if this happens).</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Hint: The staff solution uses boot_map_region.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Your code here:</span></span><br><span class="line">        <span class="comment">//boot_map_region(pde_t *pgdir, uintptr_t va, size_t size, physaddr_t pa, int perm)</span></span><br><span class="line">        size = ROUNDUP(size, PGSIZE);</span><br><span class="line">        base += size;</span><br><span class="line">        <span class="keyword">if</span> (base &gt;= MMIOLIM)</span><br><span class="line">                panic(<span class="string">&quot;exceeds MMIOLIM&quot;</span>);</span><br><span class="line">        boot_map_region(kern_pgdir, va, size, pa, PTE_PCD|PTE_PWT|PTE_W);</span><br><span class="line">        <span class="keyword">return</span> (<span class="type">void</span> *)va;</span><br><span class="line">        <span class="comment">//panic(&quot;mmio_map_region not implemented&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="bsp-like-cpu-and-ap-like-device"><a href="#bsp-like-cpu-and-ap-like-device" class="headerlink" title="bsp like cpu, and ap like device"></a>bsp like cpu, and ap like device</h1><h1 id="Exercise-2"><a href="#Exercise-2" class="headerlink" title="Exercise 2"></a>Exercise 2</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">size_t</span> npages_hole = (EXTPHYSMEM - IOPHYSMEM) / PGSIZE;</span><br><span class="line">        <span class="type">uint32_t</span> temp1 = (<span class="type">uint32_t</span>)boot_alloc(<span class="number">0</span>);</span><br><span class="line">        <span class="type">uint32_t</span> temp2 = (<span class="type">uint32_t</span>)KERNBASE;</span><br><span class="line">        <span class="type">size_t</span> npages_allocated = (temp1 - temp2) / PGSIZE;</span><br><span class="line">        <span class="type">size_t</span> mpcode_page = MPENTRY_PADDR / PGSIZE;</span><br><span class="line">        <span class="type">size_t</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; npages; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//pages[i].pp_ref = 1;</span></span><br><span class="line">                        pages[i].pp_ref = <span class="number">0</span>;</span><br><span class="line">                        pages[i].pp_link = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (i &gt;= npages_basemem &amp;&amp; i &lt; (npages_basemem + npages_hole + npages_allocated)) &#123;</span><br><span class="line">                        <span class="comment">//pages[i].pp_ref = 1;</span></span><br><span class="line">                        pages[i].pp_ref = <span class="number">0</span>;</span><br><span class="line">                        pages[i].pp_link = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (i == mpcode_page)</span><br><span class="line">                &#123;</span><br><span class="line">                        pages[i].pp_ref = <span class="number">0</span>;</span><br><span class="line">                        pages[i].pp_link = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                        pages[i].pp_ref = <span class="number">0</span>;</span><br><span class="line">                        pages[i].pp_link = page_free_list;</span><br><span class="line">                        page_free_list = &amp;pages[i];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h1><p>访问代码和访问数据的区别</p>
<ol>
<li>代码  MPBOOTPHYS</li>
<li>数据  RELOC</li>
</ol>
<h1 id="What-is-the-gdt-layout"><a href="#What-is-the-gdt-layout" class="headerlink" title="What is the gdt layout?"></a>What is the gdt layout?</h1><h1 id="What-is-per-CPU-state"><a href="#What-is-per-CPU-state" class="headerlink" title="What is  per-CPU state?"></a>What is  per-CPU state?</h1><p>Per-CPU system registers(lgdt, lidt)</p>
<h1 id="Exercise-3"><a href="#Exercise-3" class="headerlink" title="Exercise 3"></a>Exercise 3</h1><p>映射各个cpu的内核栈</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">mem_init_mp</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Map per-CPU stacks starting at KSTACKTOP, for up to &#x27;NCPU&#x27; CPUs.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// For CPU i, use the physical memory that &#x27;percpu_kstacks[i]&#x27; refers</span></span><br><span class="line">        <span class="comment">// to as its kernel stack. CPU i&#x27;s kernel stack grows down from virtual</span></span><br><span class="line">        <span class="comment">// address kstacktop_i = KSTACKTOP - i * (KSTKSIZE + KSTKGAP), and is</span></span><br><span class="line">        <span class="comment">// divided into two pieces, just like the single stack you set up in</span></span><br><span class="line">        <span class="comment">// mem_init:</span></span><br><span class="line">        <span class="comment">//     * [kstacktop_i - KSTKSIZE, kstacktop_i)</span></span><br><span class="line">        <span class="comment">//          -- backed by physical memory</span></span><br><span class="line">        <span class="comment">//     * [kstacktop_i - (KSTKSIZE + KSTKGAP), kstacktop_i - KSTKSIZE)</span></span><br><span class="line">        <span class="comment">//          -- not backed; so if the kernel overflows its stack,</span></span><br><span class="line">        <span class="comment">//             it will fault rather than overwrite another CPU&#x27;s stack.</span></span><br><span class="line">        <span class="comment">//             Known as a &quot;guard page&quot;.</span></span><br><span class="line">        <span class="comment">//     Permissions: kernel RW, user NONE</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// LAB 4: Your code here:</span></span><br><span class="line">        <span class="comment">//boot_map_region(kern_pgdir, KSTACKTOP-KSTKSIZE, KSTKSIZE, PADDR(bootstack), PTE_W);</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NCPU; i++) &#123;</span><br><span class="line">                <span class="type">uintptr_t</span> kstacktop_i = KSTACKTOP - i * (KSTKSIZE + KSTKGAP);</span><br><span class="line">                boot_map_region(kern_pgdir, kstacktop_i - KSTKSIZE, KSTKSIZE, PADDR(percpu_kstacks[i]), PTE_W);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="BSP-都做了哪些工作？"><a href="#BSP-都做了哪些工作？" class="headerlink" title="BSP 都做了哪些工作？"></a>BSP 都做了哪些工作？</h1><p>启动保护模式<br>加载内核<br>加载临时页表<br>设置页表并加载<br>…</p>
<h1 id="AP-在启动阶段需要完成哪些工作？（哪些初始化是每个-cpu-都各自单独运行一次的？）"><a href="#AP-在启动阶段需要完成哪些工作？（哪些初始化是每个-cpu-都各自单独运行一次的？）" class="headerlink" title="AP 在启动阶段需要完成哪些工作？（哪些初始化是每个 cpu 都各自单独运行一次的？）"></a>AP 在启动阶段需要完成哪些工作？（哪些初始化是每个 cpu 都各自单独运行一次的？）</h1><p>mem init 是在各个cpu 之间共享的，trap init 是什么情况呢？？？</p>
<p>AP 需要启动到可以运行一个 env 的状态</p>
<h1 id="Exercise-4"><a href="#Exercise-4" class="headerlink" title="Exercise 4"></a>Exercise 4</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">trap_init_percpu</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">uintptr_t</span> kstacktop_i = KSTACKTOP - thiscpu-&gt;cpu_id *(KSTKSIZE + KSTKGAP);</span><br><span class="line">        thiscpu-&gt;cpu_ts.ts_esp0 = kstacktop_i;</span><br><span class="line">        thiscpu-&gt;cpu_ts.ts_ss0 = GD_KD;</span><br><span class="line">        thiscpu-&gt;cpu_ts.ts_iomb = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Taskstate);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialize the TSS slot of the gdt.</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        gdt[GD_TSS0 &gt;&gt; 3] = SEG16(STS_T32A, (uint32_t) (&amp;ts),</span></span><br><span class="line"><span class="comment">                                        sizeof(struct Taskstate) - 1, 0);</span></span><br><span class="line"><span class="comment">        gdt[GD_TSS0 &gt;&gt; 3].sd_s = 0;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        gdt[(GD_TSS0 &gt;&gt; <span class="number">3</span>) + thiscpu-&gt;cpu_id] = SEG16(STS_T32A, (<span class="type">uint32_t</span>) (&amp;(thiscpu-&gt;cpu_ts)), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Taskstate) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        gdt[(GD_TSS0 &gt;&gt; <span class="number">3</span>) + thiscpu-&gt;cpu_id].sd_s = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load the TSS selector (like other segment selectors, the</span></span><br><span class="line">        <span class="comment">// bottom three bits are special; we leave them 0)</span></span><br><span class="line">        <span class="comment">// ltr(GD_TSS0);</span></span><br><span class="line">        <span class="comment">// xjk error</span></span><br><span class="line">        ltr(GD_TSS0 + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Segdesc) * thiscpu-&gt;cpu_id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load the IDT</span></span><br><span class="line">        lidt(&amp;idt_pd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="Exercise-5"><a href="#Exercise-5" class="headerlink" title="Exercise 5"></a>Exercise 5</h1><h1 id="Question-2"><a href="#Question-2" class="headerlink" title="Question 2"></a>Question 2</h1><h1 id="Exercise-6"><a href="#Exercise-6" class="headerlink" title="Exercise 6"></a>Exercise 6</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">sched_yield</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">idle</span>;</span></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        idle = thiscpu-&gt;cpu_env;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (idle != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (i = ENVX(idle-&gt;env_id) + <span class="number">1</span>; &amp;envs[i] != idle; i++, i = i % NENV) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (envs[i].env_status == ENV_RUNNABLE)</span><br><span class="line">                                env_run(&amp;envs[i]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (idle-&gt;env_status == ENV_RUNNING)</span><br><span class="line">                        env_run(idle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NENV; i++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (envs[i].env_status == ENV_RUNNABLE)</span><br><span class="line">                                env_run(&amp;envs[i]);</span><br><span class="line">                &#125;</span><br><span class="line">        sched_halt();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="Question-3"><a href="#Question-3" class="headerlink" title="Question 3"></a>Question 3</h1><p>因为各个 env 在内核空间的映射基本相同</p>
<h1 id="Question-4"><a href="#Question-4" class="headerlink" title="Question 4"></a>Question 4</h1><p>首先保存在内核栈中，然后在 trap 函数中又复制到 env-&gt;env_tf 当中</p>
<h1 id="What-we-need-to-do-for-new-env"><a href="#What-we-need-to-do-for-new-env" class="headerlink" title="What we need to do for new env???"></a>What we need to do for new env???</h1><p>initialize address space and register state</p>
<h1 id="用户空间状态之寄存器"><a href="#用户空间状态之寄存器" class="headerlink" title="用户空间状态之寄存器"></a>用户空间状态之寄存器</h1><p>8+6+2 &#x3D; 16 </p>
<p>8 General Registers<br>6 Segment Registers</p>
<p>Flags Register<br>Instruction Pointer Register</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">EAX</span><br><span class="line">EBX</span><br><span class="line">ECX</span><br><span class="line">EDX</span><br><span class="line"></span><br><span class="line">ESI</span><br><span class="line">EDI</span><br><span class="line">EBP</span><br><span class="line">ESP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CS</span><br><span class="line">DS</span><br><span class="line">SS</span><br><span class="line">ES</span><br><span class="line">FS</span><br><span class="line">GS</span><br><span class="line"></span><br><span class="line">EIP</span><br><span class="line">EFLAGS</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<!https://pdos.csail.mit.edu/6.828/2018/readings/i386/fig2-5.gif>
<p><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/s02_03.htm">https://pdos.csail.mit.edu/6.828/2018/readings/i386/s02_03.htm</a></p>
<h1 id="Exercise-7"><a href="#Exercise-7" class="headerlink" title="Exercise 7"></a>Exercise 7</h1><p>做成返回用户空间时的样子（保存的用户空间状态，寄存器）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">envid_t</span></span><br><span class="line"><span class="title function_">sys_exofork</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Create the new environment with env_alloc(), from kern/env.c.</span></span><br><span class="line">        <span class="comment">// It should be left as env_alloc created it, except that</span></span><br><span class="line">        <span class="comment">// status is set to ENV_NOT_RUNNABLE, and the register set is copied</span></span><br><span class="line">        <span class="comment">// from the current environment -- but tweaked so sys_exofork</span></span><br><span class="line">        <span class="comment">// will appear to return 0.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">newenv</span>;</span></span><br><span class="line">        <span class="type">envid_t</span> parent_id = curenv-&gt;env_id;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(ret = env_alloc(&amp;newenv, parent_id))) &#123;</span><br><span class="line">                <span class="comment">/* xjk error */</span></span><br><span class="line">                newenv-&gt;env_status = ENV_NOT_RUNNABLE;</span><br><span class="line">                newenv-&gt;env_tf = curenv-&gt;env_tf;</span><br><span class="line">                newenv-&gt;env_tf.tf_regs.reg_eax = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">/* end xjk error*/</span></span><br><span class="line">                <span class="keyword">return</span> newenv-&gt;env_id;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        panic(<span class="string">&quot;sys_exofork not implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">sys_env_set_status</span><span class="params">(<span class="type">envid_t</span> envid, <span class="type">int</span> status)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Hint: Use the &#x27;envid2env&#x27; function from kern/env.c to translate an</span></span><br><span class="line">        <span class="comment">// envid to a struct Env.</span></span><br><span class="line">        <span class="comment">// You should set envid2env&#x27;s third argument to 1, which will</span></span><br><span class="line">        <span class="comment">// check whether the current environment has permission to set</span></span><br><span class="line">        <span class="comment">// envid&#x27;s status.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">e</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (status != ENV_RUNNABLE &amp;&amp; status != ENV_NOT_RUNNABLE)</span><br><span class="line">                <span class="keyword">return</span> -E_INVAL;</span><br><span class="line">        <span class="keyword">if</span> (envid2env(envid, &amp;e, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> -E_BAD_ENV;</span><br><span class="line">        &#125;</span><br><span class="line">        e-&gt;env_status = status;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        panic(<span class="string">&quot;sys_env_set_status not implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">sys_page_alloc</span><span class="params">(<span class="type">envid_t</span> envid, <span class="type">void</span> *va, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Hint: This function is a wrapper around page_alloc() and</span></span><br><span class="line">        <span class="comment">//   page_insert() from kern/pmap.c.</span></span><br><span class="line">        <span class="comment">//   Most of the new code you write should be to check the</span></span><br><span class="line">        <span class="comment">//   parameters for correctness.</span></span><br><span class="line">        <span class="comment">//   If page_insert() fails, remember to free the page you</span></span><br><span class="line">        <span class="comment">//   allocated!</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">newpage</span>;</span></span><br><span class="line">        <span class="comment">/* not a good implement if page_alloc here, because if any fail you need to page_free()</span></span><br><span class="line"><span class="comment">        newpage = page_alloc(ALLOC_ZERO);</span></span><br><span class="line"><span class="comment">        if (newpage == NULL) return -E_NO_MEM;</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">e</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (envid2env(envid, &amp;e, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> -E_BAD_ENV;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">uintptr_t</span>)va &gt;= UTOP || ((<span class="type">uintptr_t</span>)va % PGSIZE != <span class="number">0</span>)) <span class="keyword">return</span> -E_INVAL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (perm &amp; (~PTE_SYSCALL)) <span class="keyword">return</span> -E_INVAL;</span><br><span class="line">        <span class="keyword">if</span> ( !((perm &amp; PTE_U) &amp;&amp; (perm &amp; PTE_P))) <span class="keyword">return</span> -E_INVAL;</span><br><span class="line"></span><br><span class="line">        newpage = page_alloc(ALLOC_ZERO);</span><br><span class="line">        <span class="keyword">if</span> (newpage == <span class="literal">NULL</span>) <span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">        ret = page_insert(e-&gt;env_pgdir, newpage, va, perm);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//page_free();</span></span><br><span class="line">                page_decref(newpage);</span><br><span class="line">                <span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">        panic(<span class="string">&quot;sys_page_alloc not implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">sys_page_map</span><span class="params">(<span class="type">envid_t</span> srcenvid, <span class="type">void</span> *srcva,</span></span><br><span class="line"><span class="params">             <span class="type">envid_t</span> dstenvid, <span class="type">void</span> *dstva, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Hint: This function is a wrapper around page_lookup() and</span></span><br><span class="line">        <span class="comment">//   page_insert() from kern/pmap.c.</span></span><br><span class="line">        <span class="comment">//   Again, most of the new code you write should be to check the</span></span><br><span class="line">        <span class="comment">//   parameters for correctness.</span></span><br><span class="line">        <span class="comment">//   Use the third argument to page_lookup() to</span></span><br><span class="line">        <span class="comment">//   check the current permissions on the page.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">dst_env</span>, *<span class="title">src_env</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">uintptr_t</span>)srcva &gt;= UTOP || ((<span class="type">uintptr_t</span>)srcva % PGSIZE != <span class="number">0</span>) || (<span class="type">uintptr_t</span>)dstva &gt;= UTOP || ((<span class="type">uintptr_t</span>)dstva % PGSIZE != <span class="number">0</span>))</span><br><span class="line">                <span class="keyword">return</span> -E_INVAL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (perm &amp; (~PTE_SYSCALL) || (!((perm &amp; PTE_U) &amp;&amp; (perm &amp; PTE_P)))) <span class="keyword">return</span> -E_INVAL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (envid2env(srcenvid, &amp;src_env, <span class="number">1</span>) &lt; <span class="number">0</span> || envid2env(dstenvid, &amp;dst_env, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> -E_BAD_ENV;</span><br><span class="line">        <span class="type">pte_t</span> *pte;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">src_page</span>;</span></span><br><span class="line">        <span class="comment">//envid2env(srcenvid, &amp;src_env, 1);</span></span><br><span class="line">        src_page = page_lookup(src_env-&gt;env_pgdir, srcva, &amp;pte);</span><br><span class="line">        <span class="keyword">if</span> (src_page == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">return</span> -E_INVAL;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(PGOFF(*pte) &amp; PTE_W) &amp;&amp; perm &amp; PTE_W)</span><br><span class="line">                <span class="keyword">return</span> -E_INVAL;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//envid2env(dstenvid, &amp;dst_env, 1);</span></span><br><span class="line">        <span class="keyword">if</span> (page_insert(dst_env-&gt;env_pgdir, src_page, dstva, perm) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        panic(<span class="string">&quot;sys_page_map not implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">sys_page_unmap</span><span class="params">(<span class="type">envid_t</span> envid, <span class="type">void</span> *va)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// Hint: This function is a wrapper around page_remove().</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">e</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (envid2env(envid, &amp;e, <span class="number">1</span>) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> -E_BAD_ENV;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">uintptr_t</span>)va &gt;= UTOP || ((<span class="type">uintptr_t</span>)va % PGSIZE))</span><br><span class="line">                <span class="keyword">return</span> E_INVAL;</span><br><span class="line">        page_remove(e-&gt;env_pgdir, va);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        panic(<span class="string">&quot;sys_page_unmap not implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="How-the-env-exit"><a href="#How-the-env-exit" class="headerlink" title="How the env exit ???"></a>How the env exit ???</h1><p>libmain() –&gt; exit() –&gt; sys_env_destory()</p>
<h1 id="What-is-demand-paged"><a href="#What-is-demand-paged" class="headerlink" title="What is demand-paged??"></a>What is demand-paged??</h1><h1 id="Exercise-8"><a href="#Exercise-8" class="headerlink" title="Exercise 8"></a>Exercise 8</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">sys_env_set_pgfault_upcall</span><span class="params">(<span class="type">envid_t</span> envid, <span class="type">void</span> *func)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">e</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (envid2env(envid, &amp;e, <span class="number">1</span>))</span><br><span class="line">                <span class="keyword">return</span> -E_BAD_ENV;</span><br><span class="line">        e-&gt;env_pgfault_upcall = func;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//panic(&quot;sys_env_set_pgfault_upcall not implemented&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="Exercise-9"><a href="#Exercise-9" class="headerlink" title="Exercise 9"></a>Exercise 9</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_fault_handler</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">uint32_t</span> fault_va;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read processor&#x27;s CR2 register to find the faulting address</span></span><br><span class="line">        fault_va = rcr2();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle kernel-mode page faults.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((tf-&gt;tf_cs &amp; <span class="number">0x3</span>) == <span class="number">0</span>)</span><br><span class="line">                panic(<span class="string">&quot;page_fault_handler\n&quot;</span>);</span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line"></span><br><span class="line">        <span class="type">uint32_t</span> esp;</span><br><span class="line">        <span class="keyword">if</span> (!curenv-&gt;env_pgfault_upcall)</span><br><span class="line">                <span class="keyword">goto</span> dstry;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">UTrapframe</span> *<span class="title">utf</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (tf-&gt;tf_esp &gt;= UXSTACKTOP || tf-&gt;tf_esp &lt; (UXSTACKTOP - PGSIZE)) &#123;</span><br><span class="line">                utf = (<span class="keyword">struct</span> UTrapframe *)(UXSTACKTOP - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> UTrapframe));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                utf = (<span class="keyword">struct</span> UTrapframe *)(tf-&gt;tf_esp - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> UTrapframe) - <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        user_mem_assert(curenv, (<span class="type">void</span> *)utf, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> UTrapframe), PTE_U | PTE_W);</span><br><span class="line"></span><br><span class="line">        utf-&gt;utf_fault_va = fault_va;</span><br><span class="line">        utf-&gt;utf_err = tf-&gt;tf_trapno;</span><br><span class="line">        utf-&gt;utf_eip = tf-&gt;tf_eip;</span><br><span class="line">        utf-&gt;utf_eflags = tf-&gt;tf_eflags;</span><br><span class="line">        utf-&gt;utf_esp = tf-&gt;tf_esp;</span><br><span class="line">        utf-&gt;utf_regs = tf-&gt;tf_regs;</span><br><span class="line"></span><br><span class="line">        tf-&gt;tf_eip = (<span class="type">uint32_t</span>) curenv-&gt;env_pgfault_upcall;</span><br><span class="line">        tf-&gt;tf_esp = (<span class="type">uint32_t</span>) utf;</span><br><span class="line"></span><br><span class="line">        env_run(curenv);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dstry:</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Destroy the environment that caused the fault.</span></span><br><span class="line">        cprintf(<span class="string">&quot;[%08x] user fault va %08x ip %08x\n&quot;</span>,</span><br><span class="line">                curenv-&gt;env_id, fault_va, tf-&gt;tf_eip);</span><br><span class="line">        print_trapframe(tf);</span><br><span class="line">        env_destroy(curenv);</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Exercise-10"><a href="#Exercise-10" class="headerlink" title="Exercise 10"></a>Exercise 10</h1><p>“lib&#x2F;pfentry.S”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">.globl _pgfault_upcall</span><br><span class="line">_pgfault_upcall:</span><br><span class="line">        <span class="comment">// Call the C page fault handler.</span></span><br><span class="line">        pushl %esp                      <span class="comment">// function argument: pointer to UTF</span></span><br><span class="line">        movl _pgfault_handler, %eax</span><br><span class="line">        call *%eax</span><br><span class="line">        addl $<span class="number">4</span>, %esp                   <span class="comment">// pop function argument</span></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        movl <span class="number">48</span>(%esp), %ebp</span><br><span class="line">        subl $<span class="number">4</span>, %ebp</span><br><span class="line">        movl %ebp, <span class="number">48</span>(%esp)</span><br><span class="line">        movl <span class="number">40</span>(%esp), %eax</span><br><span class="line">        movl %eax, (%ebp)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Restore the trap-time registers.  After you do this, you</span></span><br><span class="line">        <span class="comment">// can no longer modify any general-purpose registers.</span></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line"></span><br><span class="line">        addl $<span class="number">8</span>, %esp</span><br><span class="line">        popal</span><br><span class="line">        <span class="comment">// Restore eflags from the stack.  After you do this, you can</span></span><br><span class="line">        <span class="comment">// no longer use arithmetic operations or anything else that</span></span><br><span class="line">        <span class="comment">// modifies eflags.</span></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        addl $<span class="number">4</span>, %esp</span><br><span class="line">        popfl</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Switch back to the adjusted trap-time stack.</span></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line"></span><br><span class="line">        popl %esp</span><br><span class="line">        <span class="comment">// Return to re-execute the instruction that faulted.</span></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        ret</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Exercise-11"><a href="#Exercise-11" class="headerlink" title="Exercise 11"></a>Exercise 11</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">set_pgfault_handler</span><span class="params">(<span class="type">void</span> (*handler)(<span class="keyword">struct</span> UTrapframe *utf))</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_pgfault_handler == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// First time through!</span></span><br><span class="line">                <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">                <span class="keyword">if</span> ((r = sys_page_alloc(thisenv-&gt;env_id, (<span class="type">void</span> *)(UXSTACKTOP - PGSIZE), PTE_P | PTE_W | PTE_U)) &lt; <span class="number">0</span>)</span><br><span class="line">                        panic(<span class="string">&quot;set_pgfault_handler sys_page_alloc: %e&quot;</span>, r);</span><br><span class="line">                <span class="keyword">if</span> ((r = sys_env_set_pgfault_upcall(thisenv-&gt;env_id, _pgfault_upcall)) &lt; <span class="number">0</span>)</span><br><span class="line">                        panic(<span class="string">&quot;set_pgfault_handler sys_env_set_pgfault_upcall: %e&quot;</span>, r);</span><br><span class="line">                <span class="comment">//panic(&quot;set_pgfault_handler not implemented&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Save handler pointer for assembly to call.</span></span><br><span class="line">        _pgfault_handler = handler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="NOTE"><a href="#NOTE" class="headerlink" title="NOTE"></a>NOTE</h1><p>_pgfault_upcall<br>page_fault_handler</p>
<h1 id="发生页异常时，保存的-eip-是当前正在执行的，还是将要执行的下一条指令？？？"><a href="#发生页异常时，保存的-eip-是当前正在执行的，还是将要执行的下一条指令？？？" class="headerlink" title="发生页异常时，保存的 eip 是当前正在执行的，还是将要执行的下一条指令？？？"></a>发生页异常时，保存的 eip 是当前正在执行的，还是将要执行的下一条指令？？？</h1><h1 id="Exercise-12"><a href="#Exercise-12" class="headerlink" title="Exercise 12"></a>Exercise 12</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">envid_t</span></span><br><span class="line"><span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        <span class="type">envid_t</span> envid;</span><br><span class="line">        <span class="type">int</span> r;</span><br><span class="line">        <span class="type">size_t</span> i, j, pn;</span><br><span class="line">        <span class="comment">// Set up our page fault handler</span></span><br><span class="line">        set_pgfault_handler(pgfault);</span><br><span class="line"></span><br><span class="line">        envid = sys_exofork();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (envid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            panic(<span class="string">&quot;sys_exofork failed: %e&quot;</span>, envid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (envid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// child</span></span><br><span class="line">            thisenv = &amp;envs[ENVX(sys_getenvid())];</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// here is parent !</span></span><br><span class="line">        <span class="comment">// Copy our address space and page fault handler setup to the child.</span></span><br><span class="line">        <span class="keyword">for</span> (i = PDX(UTEXT); i &lt; PDX(UXSTACKTOP); i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (uvpd[i] &amp; PTE_P) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; NPTENTRIES; j++) &#123;</span><br><span class="line">                                pn = PGNUM(PGADDR(i, j, <span class="number">0</span>));</span><br><span class="line">                                <span class="keyword">if</span> (pn == PGNUM(UXSTACKTOP - PGSIZE))</span><br><span class="line">                                        <span class="keyword">break</span>;</span><br><span class="line">                                <span class="keyword">if</span> (uvpt[pn] &amp; PTE_P)</span><br><span class="line">                                        duppage(envid, pn);</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// alloc a page and map child exception stack</span></span><br><span class="line">        <span class="keyword">if</span> ((r = sys_page_alloc(envid, (<span class="type">void</span> *)(UXSTACKTOP-PGSIZE), PTE_U | PTE_P | PTE_W)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line">        <span class="keyword">extern</span> <span class="type">void</span> _pgfault_upcall(<span class="type">void</span>);</span><br><span class="line">        <span class="keyword">if</span> ((r = sys_env_set_pgfault_upcall(envid, _pgfault_upcall)) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> r;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start the child environment running</span></span><br><span class="line">        <span class="keyword">if</span> ((r = sys_env_set_status(envid, ENV_RUNNABLE)) &lt; <span class="number">0</span>)</span><br><span class="line">            panic(<span class="string">&quot;sys_env_set_status: %e&quot;</span>, r);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> envid;</span><br><span class="line">        panic(<span class="string">&quot;fork not implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>duppage() 复制映射关系</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">duppage</span><span class="params">(<span class="type">envid_t</span> envid, <span class="type">unsigned</span> pn)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">pte_t</span> table_entry;</span><br><span class="line">        <span class="type">int</span> perm;</span><br><span class="line">        <span class="type">void</span> *addr;</span><br><span class="line"></span><br><span class="line">        table_entry = PGOFF(uvpt[pn]);</span><br><span class="line">        perm = PTE_P | PTE_U;</span><br><span class="line">        addr = (<span class="type">void</span> *)(pn * PGSIZE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((table_entry &amp; PTE_W) || (table_entry &amp; PTE_COW)) &#123;</span><br><span class="line">                perm |= PTE_COW;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((r = sys_page_map(<span class="number">0</span>, addr, envid, addr, perm)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                panic(<span class="string">&quot;1 duppage page remapping failed %e&quot;</span>, r);</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (perm &amp; PTE_COW) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((r = sys_page_map(<span class="number">0</span>, addr, <span class="number">0</span>, addr, perm)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        panic(<span class="string">&quot;2 duppage page remapping failed %e&quot;</span>, r);</span><br><span class="line">                        <span class="keyword">return</span> r;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//panic(&quot;duppage not implemented&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">pgfault</span><span class="params">(<span class="keyword">struct</span> UTrapframe *utf)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">void</span> *addr = (<span class="type">void</span> *) utf-&gt;utf_fault_va;</span><br><span class="line">        <span class="type">uint32_t</span> err = utf-&gt;utf_err;</span><br><span class="line">        <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check that the faulting access was (1) a write, and (2) to a</span></span><br><span class="line">        <span class="comment">// copy-on-write page.  If not, panic.</span></span><br><span class="line">        <span class="comment">// Hint:</span></span><br><span class="line">        <span class="comment">//   Use the read-only page table mappings at uvpt</span></span><br><span class="line">        <span class="comment">//   (see &lt;inc/memlayout.h&gt;).</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        <span class="keyword">if</span> (! ( (err &amp; FEC_WR) &amp;&amp; (uvpd[PDX(addr)] &amp; PTE_P) &amp;&amp; (uvpt[PGNUM(addr)] &amp; PTE_P) &amp;&amp; (uvpt[PGNUM(addr)] &amp; PTE_COW)))</span><br><span class="line">                panic(<span class="string">&quot;Neither the fault is a write nor COW page. \n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allocate a new page, map it at a temporary location (PFTEMP),</span></span><br><span class="line">        <span class="comment">// copy the data from the old page to the new page, then move the new</span></span><br><span class="line">        <span class="comment">// page to the old page&#x27;s address.</span></span><br><span class="line">        <span class="comment">// Hint:</span></span><br><span class="line">        <span class="comment">//   You should make three system calls.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// LAB 4: Your code here.</span></span><br><span class="line">        <span class="type">envid_t</span> envid = sys_getenvid();</span><br><span class="line">        <span class="keyword">if</span> ((r = sys_page_alloc(envid, (<span class="type">void</span> *)PFTEMP, PTE_P| PTE_W|PTE_U)) &lt; <span class="number">0</span>)</span><br><span class="line">            panic(<span class="string">&quot;pgfault: page allocation fault:%e\n&quot;</span>, r);</span><br><span class="line">        addr = ROUNDDOWN(addr, PGSIZE);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">void</span> *) PFTEMP, (<span class="type">const</span> <span class="type">void</span> *) addr, PGSIZE);</span><br><span class="line">        <span class="keyword">if</span> ((r = sys_page_map(envid, (<span class="type">void</span> *) PFTEMP, envid, addr , PTE_P|PTE_W|PTE_U)) &lt; <span class="number">0</span> )</span><br><span class="line">            panic(<span class="string">&quot;pgfault: page map failed %e\n&quot;</span>, r);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((r = sys_page_unmap(envid, (<span class="type">void</span> *) PFTEMP)) &lt; <span class="number">0</span>)</span><br><span class="line">            panic(<span class="string">&quot;pgfault: page unmap failed %e\n&quot;</span>, r);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//panic(&quot;pgfault not implemented&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="在-JOS-中，虚拟地址空间有管理模块吗？"><a href="#在-JOS-中，虚拟地址空间有管理模块吗？" class="headerlink" title="在 JOS 中，虚拟地址空间有管理模块吗？"></a>在 JOS 中，虚拟地址空间有管理模块吗？</h1><p>没有，用户态虚拟地址空间是直接分配的</p>
<h1 id="段选择符"><a href="#段选择符" class="headerlink" title="段选择符?"></a>段选择符?</h1><p>gs fs</p>
<p>在内核中运行时，段寄存器 fs 被默认地指向当前用户数据空间（是怎么做到的呢）</p>
<p>在函数 tty_write() 中，需要被显示的信息取自于 fs 段指向的数据段中，即用户程序数据段中。而 printk() 函数需要显示的信息是在内核数据段中，即在内核代码中执行时 ds 指向的内核数据段中。（如何在 printk 函数中临时使用 fs） </p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>youngvoice
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://youngvoice.github.io/2022/10/09/6-828-4/" title="6.828 JOS lab4">https://youngvoice.github.io/2022/10/09/6-828-4/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/cs/" rel="tag"># cs</a>
              <a href="/tags/knowledge/" rel="tag"># knowledge</a>
              <a href="/tags/operating-system/" rel="tag"># operating system</a>
              <a href="/tags/JOS/" rel="tag"># JOS</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/09/19/daily/" rel="prev" title="由 tty 终端引发的思考？">
                  <i class="fa fa-chevron-left"></i> 由 tty 终端引发的思考？
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/10/21/average/" rel="next" title="如何在求均值的时候避免溢出？">
                  如何在求均值的时候避免溢出？ <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2022 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">youngvoice</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
