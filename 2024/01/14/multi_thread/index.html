<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"youngvoice.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="support multi-thread program running">
<meta property="og:type" content="article">
<meta property="og:title" content="how support for multi-thread (TLS + thread)">
<meta property="og:url" content="https://youngvoice.github.io/2024/01/14/multi_thread/index.html">
<meta property="og:site_name" content="I am thinking...">
<meta property="og:description" content="support multi-thread program running">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-01-14T00:00:00.000Z">
<meta property="article:modified_time" content="2024-07-20T10:36:34.034Z">
<meta property="article:author" content="youngvoice">
<meta property="article:tag" content="cs">
<meta property="article:tag" content="operating system">
<meta property="article:tag" content="process">
<meta property="article:tag" content="thread">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://youngvoice.github.io/2024/01/14/multi_thread/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://youngvoice.github.io/2024/01/14/multi_thread/","path":"2024/01/14/multi_thread/","title":"how support for multi-thread (TLS + thread)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>how support for multi-thread (TLS + thread) | I am thinking...</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?d0151213913d23785e89cc44331002a7"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">I am thinking...</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">46</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">66</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">48</span></a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#the-model-of-posix-multi-thread"><span class="nav-number">1.</span> <span class="nav-text">the model of posix multi-thread</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#the-interaction-between-signal-and-multi-thread-process"><span class="nav-number">1.1.</span> <span class="nav-text">the interaction between signal and multi-thread process</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#transfer-single-thread-program-to-multi-thread-program"><span class="nav-number">2.</span> <span class="nav-text">transfer single thread program to multi-thread program</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#related-operations"><span class="nav-number">2.1.</span> <span class="nav-text">related operations</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#related-data-structure"><span class="nav-number">2.1.1.</span> <span class="nav-text">related data structure</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#knowledge"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">knowledge</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TLS-%E6%89%BE%E5%88%87%E9%9D%A2%EF%BC%9F%EF%BC%9F"><span class="nav-number">3.</span> <span class="nav-text">TLS 找切面？？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Overview-AOSP"><span class="nav-number">4.</span> <span class="nav-text">Overview (AOSP)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#runtime"><span class="nav-number">4.1.</span> <span class="nav-text">runtime</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Access-Models"><span class="nav-number">4.2.</span> <span class="nav-text">Access Models</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ref"><span class="nav-number">5.</span> <span class="nav-text">Ref</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">youngvoice</p>
  <div class="site-description" itemprop="description">to record interesting things and questions</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://youngvoice.github.io/2024/01/14/multi_thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="youngvoice">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="I am thinking...">
      <meta itemprop="description" content="to record interesting things and questions">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="how support for multi-thread (TLS + thread) | I am thinking...">
      <meta itemprop="description" content="support multi-thread program running">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          how support for multi-thread (TLS + thread)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-01-14 00:00:00" itemprop="dateCreated datePublished" datetime="2024-01-14T00:00:00+00:00">2024-01-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-07-20 10:36:34" itemprop="dateModified" datetime="2024-07-20T10:36:34+00:00">2024-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/" itemprop="url" rel="index"><span itemprop="name">cs</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/operating-system/" itemprop="url" rel="index"><span itemprop="name">operating system</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/operating-system/process/" itemprop="url" rel="index"><span itemprop="name">process</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/cs/operating-system/process/thread/" itemprop="url" rel="index"><span itemprop="name">thread</span></a>
        </span>
    </span>

  
    <span id="/2024/01/14/multi_thread/" class="post-meta-item leancloud_visitors" data-flag-title="how support for multi-thread (TLS + thread)" title="Views">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span class="leancloud-visitors-count"></span>
    </span>
</div>

            <div class="post-description">support multi-thread program running</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="the-model-of-posix-multi-thread"><a href="#the-model-of-posix-multi-thread" class="headerlink" title="the model of posix multi-thread"></a>the model of posix multi-thread</h1><p>the leader of the new thread group<br>if the leader exit what will happen to the thread group?</p>
<h2 id="the-interaction-between-signal-and-multi-thread-process"><a href="#the-interaction-between-signal-and-multi-thread-process" class="headerlink" title="the interaction between signal and multi-thread process"></a>the interaction between signal and multi-thread process</h2><p>If  a  process-directed  signal is delivered to a thread group, and the thread group has installed a handler for the signal, then the handler will be invoked in exactly one, arbitrarily selected member of the thread group that has not blocked the signal.  If multiple threads in a group are waiting to accept  the  same  signal using sigwaitinfo(2), the kernel will arbitrarily select one of these threads to receive the signal.</p>
<h1 id="transfer-single-thread-program-to-multi-thread-program"><a href="#transfer-single-thread-program-to-multi-thread-program" class="headerlink" title="transfer single thread program to multi-thread program"></a>transfer single thread program to multi-thread program</h1><h2 id="related-operations"><a href="#related-operations" class="headerlink" title="related operations"></a>related operations</h2><p>allocating the memory needed for the thread data structures, thread-local storage, and the stack.</p>
<p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;<br>the run-time environment must be changed,</p>
<p>the binary format must be extended to define thread-local variables separate from normal variables.<br>the dynamic loader must be able to initialize these special data sections<br>the thread library must be changed to allocate new thread-local data sections for new threads.</p>
<p>&lt;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p>
<p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;<br>at startup time, the dynamic linker may perform relocations, after that the section data is kept around as the initialization image and not modified anymore.</p>
<p>since there is no one address associated with any symbol for a thread-local variable the normally used symbol table entries cannot be used. </p>
<p>load  &#x3D;&#x3D;&gt; allocate memory<br>link &#x3D;&#x3D;&gt; symbol lookup</p>
<p>map refer(object, offset) to actual virtual addresses<br>if the static model is used the address(better said, offset from the thread pointer TP) is computed using relocations by the dynamic linker at program start time and compiler generated code directly uses these offsets to find the variable addresses.</p>
<p>&lt;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p>
<p>&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt;<br>the compiler take over the job, new keyword _thread is added;<br>the memory allocated for thread-local variables in dynamically loaded modules gets freed if the module is unloaded;<br>&lt;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</p>
<p>the address operator returns the address of the variable for the current thread<br>At program start time the TCB along with the dynamic thread vector is created for the main thread;<br>for programs using thread-local storage the startup code must set up the memory for the initial thread before transferring control.</p>
<h3 id="related-data-structure"><a href="#related-data-structure" class="headerlink" title="related data structure"></a>related data structure</h3><p>section table<br>symbol table<br>    new symbol type STT_TLS is introduced<br>    in object files the st_value field would contain the usual offset from the beginning of the section the st_shndx field refers to. For executables and DSOs the st_value field contains the offset of the variable in the TLS initialization image.</p>
<p>phdr table<br>dynamic section<br>    DT_FLAGS entry dynamic linker needs the DF_STATIC_TLS flag; </p>
<p>new data structure<br>    a reference to the object and the offset of the variable in the thread-local storage section.<br>    we need new data structure to map these values to actual virtual addresses. and map the object reference to an address for the respective thread-local storage section of the module for the current thread.</p>
<h4 id="knowledge"><a href="#knowledge" class="headerlink" title="knowledge"></a>knowledge</h4><pre><code>normally used symbol table entries: in executables the st_value field would contain the absolute address of the variable at run-time, in DSOs the value would be relative to the load address.
the requirement to handle dynamically loaded objects already requires recognizing storage which is not yet allocated. 
this is the only alternative to stopping all threads and allocating storage for all threads before letting them run again.
</code></pre>
<h1 id="TLS-找切面？？"><a href="#TLS-找切面？？" class="headerlink" title="TLS 找切面？？"></a>TLS 找切面？？</h1><pre><code>init main thread 需要分配并初始化模块的非delay TLS 

load一个模块，需要 extend dtv
clone一个子线程分配并初始化模块的非delay TLS 
</code></pre>
<h1 id="Overview-AOSP"><a href="#Overview-AOSP" class="headerlink" title="Overview (AOSP)"></a>Overview (AOSP)</h1><h2 id="runtime"><a href="#runtime" class="headerlink" title="runtime"></a>runtime</h2><pre><code> compiler, linker, dynamic loader, and libc.
</code></pre>
<p>At program startup, TLS for all initially-loaded modules comprises the “Static TLS Block”. TLS variables within the Static TLS Block exist at fixed offsets from an architecture-specific thread pointer (TP) and can be accessed very efficiently – typically just a few instructions.</p>
<p>TLS variables belonging to dlopen’ed shared objects, on the other hand, may be allocated lazily, and accessing them typically requires a function call.</p>
<h2 id="Access-Models"><a href="#Access-Models" class="headerlink" title="Access Models"></a>Access Models</h2><p>When a C&#x2F;C++ file references a TLS variable, the toolchain generates instructions to find its address using a TLS “access model”</p>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><ol>
<li>ELF Handling for Thread-local storage [<a target="_blank" rel="noopener" href="https://uclibc.org/docs/tls.pdf]">https://uclibc.org/docs/tls.pdf]</a></li>
<li>bionic&#x2F;docs&#x2F;elf-tls.md</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>youngvoice
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="https://youngvoice.github.io/2024/01/14/multi_thread/" title="how support for multi-thread (TLS + thread)">https://youngvoice.github.io/2024/01/14/multi_thread/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/cs/" rel="tag"># cs</a>
              <a href="/tags/operating-system/" rel="tag"># operating system</a>
              <a href="/tags/process/" rel="tag"># process</a>
              <a href="/tags/thread/" rel="tag"># thread</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/12/24/user_stack/" rel="prev" title="how kernel implement auto grow up stack?">
                  <i class="fa fa-chevron-left"></i> how kernel implement auto grow up stack?
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/02/25/deadlock/" rel="next" title="how solve deadlock in concurrent computing ?">
                  how solve deadlock in concurrent computing ? <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2022 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">youngvoice</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"KXmlfX5j58VDYijiWp6nSyxa-gzGzoHsz","app_key":"icP17WRY0W95wXZ7w7X0pDd2","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"youngvoice/comment.youngvoice.github.io","issue_term":"title","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
